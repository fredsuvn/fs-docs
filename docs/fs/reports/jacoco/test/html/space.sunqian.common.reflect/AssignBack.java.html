<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AssignBack.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">fs-all</a> &gt; <a href="index.source.html" class="el_package">space.sunqian.common.reflect</a> &gt; <span class="el_source">AssignBack.java</span></div><h1>AssignBack.java</h1><pre class="source lang-java linenums">package space.sunqian.common.reflect;

import space.sunqian.annotations.Nonnull;

import java.lang.reflect.GenericArrayType;
import java.lang.reflect.ParameterizedType;
import java.lang.reflect.Type;
import java.lang.reflect.TypeVariable;
import java.lang.reflect.WildcardType;
import java.util.List;
import java.util.Objects;

final class AssignBack {

    public static boolean isAssignable(@Nonnull Type assigned, @Nonnull Type assignee) {
<span class="fc bfc" id="L16" title="All 2 branches covered.">        if (assigned instanceof Class&lt;?&gt;) {</span>
<span class="fc bfc" id="L17" title="All 4 branches covered.">            if (Objects.equals(assigned, assignee) || Objects.equals(assigned, Object.class)) {</span>
<span class="fc" id="L18">                return true;</span>
            }
<span class="fc bfc" id="L20" title="All 2 branches covered.">            if (assignee instanceof Class&lt;?&gt;) {</span>
<span class="fc" id="L21">                return ((Class&lt;?&gt;) assigned).isAssignableFrom((Class&lt;?&gt;) assignee);</span>
            }
<span class="fc bfc" id="L23" title="All 2 branches covered.">            if (assignee instanceof ParameterizedType) {</span>
<span class="fc" id="L24">                return isAssignable((Class&lt;?&gt;) assigned, (ParameterizedType) assignee);</span>
            }
<span class="fc bfc" id="L26" title="All 2 branches covered.">            if (assignee instanceof WildcardType) {</span>
<span class="fc" id="L27">                return isAssignable(assigned, (WildcardType) assignee);</span>
            }
<span class="fc bfc" id="L29" title="All 2 branches covered.">            if (assignee instanceof TypeVariable&lt;?&gt;) {</span>
<span class="fc" id="L30">                return isAssignable(assigned, (TypeVariable&lt;?&gt;) assignee);</span>
            }
<span class="fc bfc" id="L32" title="All 2 branches covered.">            if (assignee instanceof GenericArrayType) {</span>
<span class="fc" id="L33">                return isAssignable((Class&lt;?&gt;) assigned, (GenericArrayType) assignee);</span>
            }
<span class="fc bfc" id="L35" title="All 2 branches covered.">        } else if (assigned instanceof ParameterizedType) {</span>
<span class="fc bfc" id="L36" title="All 2 branches covered.">            if (Objects.equals(assigned, assignee)) {</span>
<span class="fc" id="L37">                return true;</span>
            }
<span class="fc bfc" id="L39" title="All 2 branches covered.">            if (assignee instanceof Class&lt;?&gt;) {</span>
<span class="fc" id="L40">                return isAssignable((ParameterizedType) assigned, (Class&lt;?&gt;) assignee);</span>
            }
<span class="fc bfc" id="L42" title="All 2 branches covered.">            if (assignee instanceof ParameterizedType) {</span>
<span class="fc" id="L43">                return isAssignable((ParameterizedType) assigned, (ParameterizedType) assignee);</span>
            }
<span class="fc bfc" id="L45" title="All 2 branches covered.">            if (assignee instanceof WildcardType) {</span>
<span class="fc" id="L46">                return isAssignable(assigned, (WildcardType) assignee);</span>
            }
<span class="fc bfc" id="L48" title="All 2 branches covered.">            if (assignee instanceof TypeVariable&lt;?&gt;) {</span>
<span class="fc" id="L49">                return isAssignable(assigned, (TypeVariable&lt;?&gt;) assignee);</span>
            }
            // if (assignee instanceof GenericArrayType) {
            //     return false;
            // }
<span class="fc bfc" id="L54" title="All 2 branches covered.">        } else if (assigned instanceof WildcardType) {</span>
<span class="fc" id="L55">            return isAssignable((WildcardType) assigned, assignee);</span>
<span class="fc bfc" id="L56" title="All 2 branches covered.">        } else if (assigned instanceof TypeVariable&lt;?&gt;) {</span>
<span class="fc bfc" id="L57" title="All 2 branches covered.">            if (Objects.equals(assigned, assignee)) {</span>
<span class="fc" id="L58">                return true;</span>
            }
            // if (assignee instanceof Class&lt;?&gt;) {
            //     return isAssignable((TypeVariable&lt;?&gt;) assigned, (Class&lt;?&gt;) assignee);
            // }
            // if (assignee instanceof ParameterizedType) {
            //     return isAssignable((TypeVariable&lt;?&gt;) assigned, (ParameterizedType) assignee);
            // }
<span class="fc bfc" id="L66" title="All 2 branches covered.">            if (assignee instanceof WildcardType) {</span>
<span class="fc" id="L67">                return isAssignable(assigned, (WildcardType) assignee);</span>
            }
<span class="fc bfc" id="L69" title="All 2 branches covered.">            if (assignee instanceof TypeVariable&lt;?&gt;) {</span>
<span class="fc" id="L70">                return isAssignable(assigned, (TypeVariable&lt;?&gt;) assignee);</span>
            }
            // if (assignee instanceof GenericArrayType) {
            //     return isAssignable((TypeVariable&lt;?&gt;) assigned, (GenericArrayType) assignee);
            // }
<span class="fc bfc" id="L75" title="All 2 branches covered.">        } else if (assigned instanceof GenericArrayType) {</span>
<span class="fc bfc" id="L76" title="All 2 branches covered.">            if (Objects.equals(assigned, assignee)) {</span>
<span class="fc" id="L77">                return true;</span>
            }
<span class="fc bfc" id="L79" title="All 2 branches covered.">            if (assignee instanceof Class&lt;?&gt;) {</span>
<span class="fc" id="L80">                return isAssignable((GenericArrayType) assigned, (Class&lt;?&gt;) assignee);</span>
            }
<span class="fc bfc" id="L82" title="All 2 branches covered.">            if (assignee instanceof ParameterizedType) {</span>
<span class="fc" id="L83">                return isAssignable((GenericArrayType) assigned, (ParameterizedType) assignee);</span>
            }
<span class="fc bfc" id="L85" title="All 2 branches covered.">            if (assignee instanceof WildcardType) {</span>
<span class="fc" id="L86">                return isAssignable(assigned, (WildcardType) assignee);</span>
            }
<span class="fc bfc" id="L88" title="All 2 branches covered.">            if (assignee instanceof TypeVariable&lt;?&gt;) {</span>
<span class="fc" id="L89">                return isAssignable(assigned, (TypeVariable&lt;?&gt;) assignee);</span>
            }
<span class="fc bfc" id="L91" title="All 2 branches covered.">            if (assignee instanceof GenericArrayType) {</span>
<span class="fc" id="L92">                return isAssignable((GenericArrayType) assigned, (GenericArrayType) assignee);</span>
            }
        }
<span class="fc" id="L95">        return false;</span>
    }

    private static boolean isAssignable(@Nonnull Class&lt;?&gt; assigned, @Nonnull ParameterizedType assignee) {
<span class="fc" id="L99">        Type assigneeRaw = assignee.getRawType();</span>
<span class="fc bfc" id="L100" title="All 2 branches covered.">        if (!(assigneeRaw instanceof Class&lt;?&gt;)) {</span>
<span class="fc" id="L101">            return false;</span>
        }
<span class="fc" id="L103">        return assigned.isAssignableFrom((Class&lt;?&gt;) assigneeRaw);</span>
    }

    private static boolean isAssignable(@Nonnull Class&lt;?&gt; assigned, @Nonnull GenericArrayType assignee) {
<span class="fc bfc" id="L107" title="All 2 branches covered.">        if (!assigned.isArray()) {</span>
<span class="fc" id="L108">            return false;</span>
        }
<span class="fc" id="L110">        Type assignedComponent = assigned.getComponentType();</span>
<span class="fc" id="L111">        Type assigneeComponent = assignee.getGenericComponentType();</span>
<span class="fc" id="L112">        return isAssignable(assignedComponent, assigneeComponent);</span>
    }

    private static boolean isAssignable(@Nonnull ParameterizedType assigned, @Nonnull Class&lt;?&gt; assignee) {
<span class="fc" id="L116">        Class&lt;?&gt; assignedRaw = (Class&lt;?&gt;) assigned.getRawType();</span>
<span class="fc" id="L117">        return assignedRaw.isAssignableFrom(assignee);</span>
    }

    private static boolean isAssignable(@Nonnull ParameterizedType assigned, @Nonnull ParameterizedType assignee) {
<span class="fc" id="L121">        Type assignedRaw = assigned.getRawType();</span>
<span class="fc bfc" id="L122" title="All 2 branches covered.">        if (!(assignedRaw instanceof Class&lt;?&gt;)) {</span>
<span class="fc" id="L123">            return false;</span>
        }
<span class="fc" id="L125">        Type assigneeRaw = assignee.getRawType();</span>
<span class="fc bfc" id="L126" title="All 2 branches covered.">        if (!(assigneeRaw instanceof Class&lt;?&gt;)) {</span>
<span class="fc" id="L127">            return false;</span>
        }
<span class="fc bfc" id="L129" title="All 2 branches covered.">        if (!((Class&lt;?&gt;) assignedRaw).isAssignableFrom((Class&lt;?&gt;) assigneeRaw)) {</span>
<span class="fc" id="L130">            return false;</span>
        }
<span class="fc" id="L132">        List&lt;Type&gt; assigneeArgs = TypeKit.resolveActualTypeArguments(assignee, (Class&lt;?&gt;) assignedRaw);</span>
<span class="fc" id="L133">        Type[] assignedArgs = assigned.getActualTypeArguments();</span>
<span class="fc bfc" id="L134" title="All 2 branches covered.">        if (assignedArgs.length != assigneeArgs.size()) {</span>
<span class="fc" id="L135">            return false;</span>
        }
<span class="fc bfc" id="L137" title="All 2 branches covered.">        for (int i = 0; i &lt; assignedArgs.length; i++) {</span>
<span class="fc" id="L138">            Type assignedArg = assignedArgs[i];</span>
<span class="fc" id="L139">            Type assigneeArg = assigneeArgs.get(i);</span>
<span class="fc bfc" id="L140" title="All 2 branches covered.">            if (assignedArg instanceof WildcardType) {</span>
<span class="fc bfc" id="L141" title="All 2 branches covered.">                if (!isAssignableParameterizedArgs((WildcardType) assignedArg, assigneeArg)) {</span>
<span class="fc" id="L142">                    return false;</span>
                }
                continue;
            }
<span class="fc bfc" id="L146" title="All 2 branches covered.">            if (!Objects.equals(assignedArg, assigneeArg)) {</span>
<span class="fc" id="L147">                return false;</span>
            }
        }
<span class="fc" id="L150">        return true;</span>
    }

    private static boolean isAssignableParameterizedArgs(@Nonnull WildcardType assignedArg, @Nonnull Type assigneeArg) {
<span class="fc" id="L154">        Type assignedUpper = TypeKit.getUpperBound(assignedArg);</span>
<span class="fc bfc" id="L155" title="All 2 branches covered.">        if (!isAssignable(assignedUpper, assigneeArg)) {</span>
<span class="fc" id="L156">            return false;</span>
        }
<span class="fc" id="L158">        Type assignedLower = TypeKit.getLowerBound(assignedArg);</span>
<span class="fc bfc" id="L159" title="All 4 branches covered.">        return assignedLower == null || isAssignable(assigneeArg, assignedLower);</span>
    }

    private static boolean isAssignable(@Nonnull WildcardType assigned, @Nonnull Type assignee) {
<span class="fc" id="L163">        Type lowerType = TypeKit.getLowerBound(assigned);</span>
<span class="fc bfc" id="L164" title="All 2 branches covered.">        if (lowerType != null) {</span>
<span class="fc" id="L165">            return isAssignable(lowerType, assignee);</span>
        }
<span class="fc" id="L167">        return false;</span>
    }

    private static boolean isAssignable(@Nonnull Type assigned, @Nonnull WildcardType assignee) {
<span class="fc" id="L171">        Type assigneeUpper = TypeKit.getUpperBound(assignee);</span>
<span class="fc" id="L172">        return isAssignable(assigned, assigneeUpper);</span>
    }

    private static boolean isAssignable(@Nonnull Type assigned, @Nonnull TypeVariable&lt;?&gt; assignee) {
<span class="fc" id="L176">        Type[] assigneeUppers = assignee.getBounds();</span>
<span class="fc bfc" id="L177" title="All 2 branches covered.">        for (Type assigneeUpper : assigneeUppers) {</span>
<span class="fc bfc" id="L178" title="All 2 branches covered.">            if (isAssignable(assigned, assigneeUpper)) {</span>
<span class="fc" id="L179">                return true;</span>
            }
        }
<span class="fc" id="L182">        return false;</span>
    }

    private static boolean isAssignable(@Nonnull GenericArrayType assigned, @Nonnull Class&lt;?&gt; assignee) {
<span class="fc bfc" id="L186" title="All 2 branches covered.">        if (!assignee.isArray()) {</span>
<span class="fc" id="L187">            return false;</span>
        }
<span class="fc" id="L189">        Type assignedComponent = assigned.getGenericComponentType();</span>
<span class="fc" id="L190">        Type assigneeComponent = assignee.getComponentType();</span>
<span class="fc" id="L191">        return isAssignable(assignedComponent, assigneeComponent);</span>
    }

    private static boolean isAssignable(@Nonnull GenericArrayType assigned, @Nonnull ParameterizedType assignee) {
<span class="fc" id="L195">        return false;</span>
    }

    private static boolean isAssignable(@Nonnull GenericArrayType assigned, @Nonnull GenericArrayType assignee) {
<span class="fc" id="L199">        Type assignedComponent = assigned.getGenericComponentType();</span>
<span class="fc" id="L200">        Type assigneeComponent = assignee.getGenericComponentType();</span>
<span class="fc" id="L201">        return isAssignable(assignedComponent, assigneeComponent);</span>
    }

    private AssignBack() {
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>