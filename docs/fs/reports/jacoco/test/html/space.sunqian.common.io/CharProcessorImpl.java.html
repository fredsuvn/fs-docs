<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CharProcessorImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">fs-all</a> &gt; <a href="index.source.html" class="el_package">space.sunqian.common.io</a> &gt; <span class="el_source">CharProcessorImpl.java</span></div><h1>CharProcessorImpl.java</h1><pre class="source lang-java linenums">package space.sunqian.common.io;

import space.sunqian.annotations.Nonnull;
import space.sunqian.annotations.Nullable;

import java.io.IOException;
import java.io.Reader;
import java.io.Writer;
import java.nio.CharBuffer;
import java.util.ArrayList;
import java.util.List;

final class CharProcessorImpl implements CharProcessor {

    private final @Nonnull CharReader src;
<span class="fc" id="L16">    private long readLimit = -1;</span>
<span class="fc" id="L17">    private int readBlockSize = IOKit.bufferSize();</span>
<span class="fc" id="L18">    private @Nullable List&lt;CharTransformer&gt; transformers = null;</span>

<span class="fc" id="L20">    CharProcessorImpl(@Nonnull CharReader src) {</span>
<span class="fc" id="L21">        this.src = src;</span>
<span class="fc" id="L22">    }</span>

    @Override
    public @Nonnull CharProcessor readLimit(long readLimit) throws IllegalArgumentException {
<span class="fc" id="L26">        IOChecker.checkReadLimit(readLimit);</span>
<span class="fc" id="L27">        this.readLimit = readLimit;</span>
<span class="fc" id="L28">        return this;</span>
    }

    @Override
    public @Nonnull CharProcessor readBlockSize(int readBlockSize) throws IllegalArgumentException {
<span class="fc" id="L33">        IOChecker.checkReadBlockSize(readBlockSize);</span>
<span class="fc" id="L34">        this.readBlockSize = readBlockSize;</span>
<span class="fc" id="L35">        return this;</span>
    }

    @Override
    public @Nonnull CharProcessor transformer(@Nonnull CharTransformer transformer) {
<span class="fc bfc" id="L40" title="All 2 branches covered.">        if (transformers == null) {</span>
<span class="fc" id="L41">            transformers = new ArrayList&lt;&gt;();</span>
        }
<span class="fc" id="L43">        transformers.add(transformer);</span>
<span class="fc" id="L44">        return this;</span>
    }

    @Override
    public long processTo(@Nonnull Appendable dst) throws IORuntimeException {
        try {
<span class="fc bfc" id="L50" title="All 2 branches covered.">            if (transformers == null) {</span>
<span class="fc bfc" id="L51" title="All 2 branches covered.">                CharReader reader = readLimit &lt; 0 ? src : src.limit(readLimit);</span>
<span class="fc" id="L52">                return reader.readTo(dst);</span>
            }
<span class="fc" id="L54">            return encode(dst, transformers);</span>
<span class="fc" id="L55">        } catch (Exception e) {</span>
<span class="fc" id="L56">            throw new IORuntimeException(e);</span>
        }
    }

    @Override
    public long processTo(char @Nonnull [] dst) throws IORuntimeException {
        try {
<span class="fc" id="L63">            Writer out = IOKit.newWriter(dst);</span>
<span class="fc bfc" id="L64" title="All 2 branches covered.">            if (transformers == null) {</span>
<span class="fc bfc" id="L65" title="All 2 branches covered.">                CharReader reader = readLimit &lt; 0 ? src : src.limit(readLimit);</span>
<span class="fc" id="L66">                return reader.readTo(out);</span>
            }
<span class="fc" id="L68">            return encode(out, transformers);</span>
<span class="fc" id="L69">        } catch (Exception e) {</span>
<span class="fc" id="L70">            throw new IORuntimeException(e);</span>
        }
    }

    @Override
    public long processTo(char @Nonnull [] dst, int off) throws IndexOutOfBoundsException, IORuntimeException {
<span class="fc" id="L76">        Writer out = IOKit.newWriter(dst, off, dst.length - off);</span>
        try {
<span class="fc bfc" id="L78" title="All 2 branches covered.">            if (transformers == null) {</span>
<span class="fc bfc" id="L79" title="All 2 branches covered.">                CharReader reader = readLimit &lt; 0 ? src : src.limit(readLimit);</span>
<span class="fc" id="L80">                return reader.readTo(out);</span>
            }
<span class="fc" id="L82">            return encode(out, transformers);</span>
<span class="fc" id="L83">        } catch (Exception e) {</span>
<span class="fc" id="L84">            throw new IORuntimeException(e);</span>
        }
    }

    @Override
    public long processTo(@Nonnull CharBuffer dst) throws IORuntimeException {
        try {
<span class="fc" id="L91">            Writer out = IOKit.newWriter(dst);</span>
<span class="fc bfc" id="L92" title="All 2 branches covered.">            if (transformers == null) {</span>
<span class="fc bfc" id="L93" title="All 2 branches covered.">                CharReader reader = readLimit &lt; 0 ? src : src.limit(readLimit);</span>
<span class="fc" id="L94">                return reader.readTo(out);</span>
            }
<span class="fc" id="L96">            return encode(out, transformers);</span>
<span class="fc" id="L97">        } catch (Exception e) {</span>
<span class="fc" id="L98">            throw new IORuntimeException(e);</span>
        }
    }

    @Override
    public @Nonnull String toString() {
<span class="fc" id="L104">        return new String(toCharArray());</span>
    }

    private long encode(@Nonnull Object dst, @Nonnull List&lt;@Nonnull CharTransformer&gt; transformers) throws Exception {
<span class="fc bfc" id="L108" title="All 2 branches covered.">        CharReader reader = readLimit &lt; 0 ? src : src.limit(readLimit);</span>
<span class="fc" id="L109">        long count = 0;</span>
        while (true) {
<span class="fc" id="L111">            CharSegment block = reader.read(readBlockSize);</span>
<span class="fc" id="L112">            CharBuffer data = block.data();</span>
<span class="fc" id="L113">            count += data.remaining();</span>
<span class="fc" id="L114">            boolean end = block.end();</span>
<span class="fc bfc" id="L115" title="All 2 branches covered.">            for (CharTransformer transformer : transformers) {</span>
<span class="fc bfc" id="L116" title="All 2 branches covered.">                if (data == null) {</span>
<span class="fc" id="L117">                    break;</span>
                }
<span class="fc" id="L119">                data = transformer.transform(data, end);</span>
<span class="fc" id="L120">            }</span>
<span class="fc bfc" id="L121" title="All 2 branches covered.">            if (data != null) {</span>
<span class="fc" id="L122">                writeTo(data, dst);</span>
            }
<span class="fc bfc" id="L124" title="All 2 branches covered.">            if (end) {</span>
<span class="fc" id="L125">                break;</span>
            }
<span class="fc" id="L127">        }</span>
<span class="fc bfc" id="L128" title="All 2 branches covered.">        return count == 0L ? -1 : count;</span>
    }

    private void writeTo(@Nonnull CharBuffer data, @Nonnull Object dst) {
<span class="fc bfc" id="L132" title="All 2 branches covered.">        if (dst instanceof Writer) {</span>
<span class="fc" id="L133">            BufferKit.readTo(data, (Writer) dst);</span>
        } else {
<span class="fc" id="L135">            throw new UnsupportedOperationException(&quot;Unsupported destination: &quot; + dst.getClass() + &quot;.&quot;);</span>
        }
<span class="fc" id="L137">    }</span>

    @Override
    public @Nonnull Reader asReader() {
<span class="fc bfc" id="L141" title="All 2 branches covered.">        CharReader reader = readLimit &lt; 0 ? src : src.limit(readLimit);</span>
<span class="fc bfc" id="L142" title="All 2 branches covered.">        if (transformers == null) {</span>
<span class="fc" id="L143">            return reader.asReader();</span>
        }
<span class="fc" id="L145">        return new EncoderReader(reader, readBlockSize, transformers);</span>
    }

    @Override
    public @Nonnull CharReader asCharReader() {
<span class="fc bfc" id="L150" title="All 2 branches covered.">        if (transformers == null) {</span>
<span class="fc bfc" id="L151" title="All 2 branches covered.">            return readLimit &lt; 0 ? src : src.limit(readLimit);</span>
        }
<span class="fc" id="L153">        return CharReader.from(asReader());</span>
    }

    private static final class EncoderReader extends Reader {

        private final @Nonnull CharReader reader;
        private final int readBlockSize;
        private final @Nonnull List&lt;@Nonnull CharTransformer&gt; transformers;

<span class="fc" id="L162">        private @Nullable CharSegment nextSeg = null;</span>
<span class="fc" id="L163">        private boolean closed = false;</span>

        private EncoderReader(
            @Nonnull CharReader reader, int readBlockSize, @Nonnull List&lt;@Nonnull CharTransformer&gt; transformers
<span class="fc" id="L167">        ) {</span>
<span class="fc" id="L168">            this.reader = reader;</span>
<span class="fc" id="L169">            this.readBlockSize = readBlockSize;</span>
<span class="fc" id="L170">            this.transformers = transformers;</span>
<span class="fc" id="L171">        }</span>

        private @Nonnull CharSegment nextSeg() throws IOException {
            try {
                CharSegment next;
                do {
<span class="fc" id="L177">                    next = next();</span>
<span class="fc bfc" id="L178" title="All 2 branches covered.">                } while (next == null);</span>
<span class="fc" id="L179">                return next;</span>
<span class="fc" id="L180">            } catch (Exception e) {</span>
<span class="fc" id="L181">                throw new IOException(e);</span>
            }
        }

        private @Nullable CharSegment next() throws Exception {
<span class="fc" id="L186">            CharSegment block = reader.read(readBlockSize);</span>
<span class="fc" id="L187">            CharBuffer data = block.data();</span>
<span class="fc" id="L188">            boolean end = block.end();</span>
<span class="fc bfc" id="L189" title="All 2 branches covered.">            for (CharTransformer transformer : transformers) {</span>
<span class="fc bfc" id="L190" title="All 2 branches covered.">                if (data == null) {</span>
<span class="fc" id="L191">                    break;</span>
                }
<span class="fc" id="L193">                data = transformer.transform(data, end);</span>
<span class="fc" id="L194">            }</span>
<span class="fc bfc" id="L195" title="All 2 branches covered.">            if (data == null) {</span>
<span class="fc" id="L196">                return null;</span>
            }
<span class="fc bfc" id="L198" title="All 2 branches covered.">            if (data == block.data()) {</span>
<span class="fc" id="L199">                return block;</span>
            }
<span class="fc" id="L201">            return CharSegment.of(data, end);</span>
        }

        @Override
        public int read() throws IOException {
<span class="fc" id="L206">            checkClosed();</span>
            while (true) {
<span class="fc bfc" id="L208" title="All 2 branches covered.">                if (nextSeg == null) {</span>
<span class="fc" id="L209">                    nextSeg = nextSeg();</span>
                }
<span class="fc bfc" id="L211" title="All 2 branches covered.">                if (nextSeg == CharSegment.empty(true)) {</span>
<span class="fc" id="L212">                    return -1;</span>
                }
<span class="fc bfc" id="L214" title="All 2 branches covered.">                if (nextSeg.data().hasRemaining()) {</span>
<span class="fc" id="L215">                    return nextSeg.data().get();</span>
                }
<span class="fc bfc" id="L217" title="All 2 branches covered.">                if (nextSeg.end()) {</span>
<span class="fc" id="L218">                    nextSeg = CharSegment.empty(true);</span>
<span class="fc" id="L219">                    return -1;</span>
                }
<span class="fc" id="L221">                nextSeg = null;</span>
            }
        }

        @Override
        public int read(char @Nonnull [] b) throws IOException {
<span class="fc" id="L227">            return read(b, 0, b.length);</span>
        }

        @Override
        public int read(char @Nonnull [] dst, int off, int len) throws IOException {
<span class="fc" id="L232">            checkClosed();</span>
<span class="fc" id="L233">            IOChecker.checkOffLen(off, len, dst.length);</span>
<span class="fc bfc" id="L234" title="All 2 branches covered.">            if (len == 0) {</span>
<span class="fc" id="L235">                return 0;</span>
            }
<span class="fc" id="L237">            return read0(dst, off, len);</span>
        }

        @Override
        public long skip(long n) throws IOException {
<span class="fc" id="L242">            checkClosed();</span>
<span class="fc bfc" id="L243" title="All 2 branches covered.">            if (n &lt; 0L) {</span>
<span class="fc" id="L244">                throw new IllegalArgumentException(&quot;skip value is negative&quot;);</span>
            }
<span class="fc bfc" id="L246" title="All 2 branches covered.">            if (n == 0) {</span>
<span class="fc" id="L247">                return 0;</span>
            }
<span class="fc" id="L249">            return read0(null, 0, n);</span>
        }

        private int read0(char @Nullable [] dst, int off, long len) throws IOException {
<span class="fc" id="L253">            int pos = 0;</span>
<span class="fc bfc" id="L254" title="All 2 branches covered.">            while (pos &lt; len) {</span>
<span class="fc bfc" id="L255" title="All 2 branches covered.">                if (nextSeg == null) {</span>
<span class="fc" id="L256">                    nextSeg = nextSeg();</span>
                }
<span class="fc bfc" id="L258" title="All 2 branches covered.">                if (nextSeg == CharSegment.empty(true)) {</span>
<span class="fc" id="L259">                    break;</span>
                }
<span class="fc" id="L261">                CharBuffer data = nextSeg.data();</span>
<span class="fc bfc" id="L262" title="All 2 branches covered.">                if (data.hasRemaining()) {</span>
<span class="fc" id="L263">                    int readSize = (int) Math.min(data.remaining(), len - pos);</span>
<span class="fc bfc" id="L264" title="All 2 branches covered.">                    if (dst != null) {</span>
<span class="fc" id="L265">                        data.get(dst, pos + off, readSize);</span>
                    } else {
<span class="fc" id="L267">                        data.position(data.position() + readSize);</span>
                    }
<span class="fc" id="L269">                    pos += readSize;</span>
<span class="fc" id="L270">                    continue;</span>
                }
<span class="fc bfc" id="L272" title="All 2 branches covered.">                if (nextSeg.end()) {</span>
<span class="fc" id="L273">                    nextSeg = CharSegment.empty(true);</span>
<span class="fc" id="L274">                    break;</span>
                }
<span class="fc" id="L276">                nextSeg = null;</span>
<span class="fc" id="L277">            }</span>
<span class="fc bfc" id="L278" title="All 4 branches covered.">            return pos == 0 ? (dst == null ? 0 : -1) : pos;</span>
        }

        @Override
        public void close() throws IOException {
<span class="fc bfc" id="L283" title="All 2 branches covered.">            if (closed) {</span>
<span class="fc" id="L284">                return;</span>
            }
            try {
<span class="fc" id="L287">                reader.close();</span>
<span class="fc" id="L288">            } catch (Exception e) {</span>
<span class="fc" id="L289">                throw new IOException(e);</span>
<span class="fc" id="L290">            }</span>
<span class="fc" id="L291">            closed = true;</span>
<span class="fc" id="L292">        }</span>

        private void checkClosed() throws IOException {
<span class="fc bfc" id="L295" title="All 2 branches covered.">            if (closed) {</span>
<span class="fc" id="L296">                throw new IOException(&quot;Stream closed.&quot;);</span>
            }
<span class="fc" id="L298">        }</span>
    }

    private static abstract class ResidualSizeHandler implements CharTransformer {

        protected final @Nonnull CharTransformer transformer;
        protected final int size;

        // Residual data;
        // Its capacity is always the size.
        private @Nullable CharBuffer residual;

<span class="fc" id="L310">        protected ResidualSizeHandler(@Nonnull CharTransformer transformer, int size) throws IllegalArgumentException {</span>
<span class="fc" id="L311">            this.transformer = transformer;</span>
<span class="fc" id="L312">            this.size = size;</span>
<span class="fc" id="L313">        }</span>

        protected abstract @Nullable List&lt;CharBuffer&gt; handleMultiple(
            @Nonnull CharBuffer data, boolean end
        ) throws Exception;

        @Override
        public @Nullable CharBuffer transform(@Nonnull CharBuffer data, boolean end) throws Exception {

            // clean buffer
<span class="fc" id="L323">            CharBuffer previousResult = null;</span>
<span class="fc bfc" id="L324" title="All 4 branches covered.">            if (residual != null &amp;&amp; residual.position() &gt; 0) {</span>
<span class="fc" id="L325">                BufferKit.readTo(data, residual);</span>
<span class="fc bfc" id="L326" title="All 2 branches covered.">                if (residual.hasRemaining()) {</span>
                    // in this case data must be empty
<span class="fc bfc" id="L328" title="All 2 branches covered.">                    if (end) {</span>
<span class="fc" id="L329">                        residual.flip();</span>
<span class="fc" id="L330">                        return transformer.transform(residual, true);</span>
                    } else {
<span class="fc" id="L332">                        return null;</span>
                    }
                } else {
<span class="fc" id="L335">                    residual.flip();</span>
<span class="fc bfc" id="L336" title="All 2 branches covered.">                    if (end) {</span>
<span class="fc bfc" id="L337" title="All 2 branches covered.">                        if (data.hasRemaining()) {</span>
<span class="fc" id="L338">                            previousResult = transformer.transform(BufferKit.copy(residual), false);</span>
                        } else {
<span class="fc" id="L340">                            return transformer.transform(residual, true);</span>
                        }
                    } else {
<span class="fc" id="L343">                        previousResult = transformer.transform(BufferKit.copy(residual), false);</span>
                    }
<span class="fc" id="L345">                    residual.clear();</span>
                }
            }

            // multiple
<span class="fc" id="L350">            List&lt;CharBuffer&gt; multipleResult = handleMultiple(data, end);</span>

            // remainder
<span class="fc" id="L353">            CharBuffer residualResult = null;</span>
<span class="fc bfc" id="L354" title="All 2 branches covered.">            if (data.hasRemaining()) {</span>
<span class="fc bfc" id="L355" title="All 2 branches covered.">                if (residual == null) {</span>
<span class="fc" id="L356">                    residual = CharBuffer.allocate(size);</span>
                }
<span class="fc" id="L358">                BufferKit.readTo(data, residual);</span>
<span class="fc bfc" id="L359" title="All 2 branches covered.">                if (end) {</span>
<span class="fc" id="L360">                    residual.flip();</span>
<span class="fc" id="L361">                    residualResult = transformer.transform(residual, true);</span>
                }
            }

            // empty end
<span class="fc bfc" id="L366" title="All 8 branches covered.">            if (end &amp;&amp; previousResult == null &amp;&amp; multipleResult == null &amp;&amp; residualResult == null) {</span>
<span class="fc" id="L367">                return transformer.transform(CharBuffer.allocate(0), true);</span>
            }

<span class="fc" id="L370">            return mergeResult(previousResult, multipleResult, residualResult);</span>
        }

        private @Nullable CharBuffer mergeResult(
            @Nullable CharBuffer previousResult,
            @Nullable List&lt;@Nonnull CharBuffer&gt; multipleResult,
            @Nullable CharBuffer residualResult
        ) {
<span class="fc" id="L378">            int totalSize = 0;</span>
<span class="fc bfc" id="L379" title="All 2 branches covered.">            if (previousResult != null) {</span>
<span class="fc" id="L380">                totalSize += previousResult.remaining();</span>
            }
<span class="fc bfc" id="L382" title="All 2 branches covered.">            if (residualResult != null) {</span>
<span class="fc" id="L383">                totalSize += residualResult.remaining();</span>
            }
<span class="fc bfc" id="L385" title="All 2 branches covered.">            if (multipleResult != null) {</span>
<span class="fc bfc" id="L386" title="All 2 branches covered.">                for (CharBuffer buf : multipleResult) {</span>
<span class="fc" id="L387">                    totalSize += buf.remaining();</span>
<span class="fc" id="L388">                }</span>
            }
<span class="fc bfc" id="L390" title="All 2 branches covered.">            if (totalSize == 0) {</span>
<span class="fc" id="L391">                return null;</span>
            }
<span class="fc" id="L393">            CharBuffer result = CharBuffer.allocate(totalSize);</span>
<span class="fc bfc" id="L394" title="All 2 branches covered.">            if (previousResult != null) {</span>
<span class="fc" id="L395">                BufferKit.readTo(previousResult, result);</span>
            }
<span class="fc bfc" id="L397" title="All 2 branches covered.">            if (multipleResult != null) {</span>
<span class="fc bfc" id="L398" title="All 2 branches covered.">                for (CharBuffer buf : multipleResult) {</span>
<span class="fc" id="L399">                    BufferKit.readTo(buf, result);</span>
<span class="fc" id="L400">                }</span>
            }
<span class="fc bfc" id="L402" title="All 2 branches covered.">            if (residualResult != null) {</span>
<span class="fc" id="L403">                BufferKit.readTo(residualResult, result);</span>
            }
<span class="fc" id="L405">            result.flip();</span>
<span class="fc" id="L406">            return result;</span>
        }
    }

    static final class FixedSizeHandler extends ResidualSizeHandler {

        FixedSizeHandler(@Nonnull CharTransformer transformer, int size) throws IllegalArgumentException {
<span class="fc" id="L413">            super(transformer, size);</span>
<span class="fc" id="L414">        }</span>

        @Override
        protected @Nullable List&lt;CharBuffer&gt; handleMultiple(@Nonnull CharBuffer data, boolean end) throws Exception {
<span class="fc" id="L418">            int remainingSize = data.remaining();</span>
<span class="fc bfc" id="L419" title="All 2 branches covered.">            if (remainingSize &lt;= 0) {</span>
<span class="fc" id="L420">                return null;</span>
            }
<span class="fc" id="L422">            List&lt;CharBuffer&gt; multipleResult = null;</span>
<span class="fc" id="L423">            int multipleSize = remainingSize / size * size;</span>
<span class="fc bfc" id="L424" title="All 2 branches covered.">            if (multipleSize &gt; 0) {</span>
<span class="fc" id="L425">                multipleResult = new ArrayList&lt;&gt;(multipleSize / size);</span>
<span class="fc" id="L426">                int curSize = multipleSize;</span>
<span class="fc bfc" id="L427" title="All 2 branches covered.">                while (curSize &gt; 0) {</span>
<span class="fc" id="L428">                    CharBuffer multiple = BufferKit.slice0(data, 0, size);</span>
<span class="fc" id="L429">                    data.position(data.position() + size);</span>
<span class="fc bfc" id="L430" title="All 6 branches covered.">                    CharBuffer multipleRet = transformer.transform(</span>
                        multiple,
                        end &amp;&amp; multipleSize == remainingSize &amp;&amp; curSize == size
                    );
<span class="fc" id="L434">                    multipleResult.add(multipleRet);</span>
<span class="fc" id="L435">                    curSize -= size;</span>
<span class="fc" id="L436">                }</span>
            }
<span class="fc" id="L438">            return multipleResult;</span>
        }
    }

    static final class MultipleSizeHandler extends ResidualSizeHandler {

<span class="fc" id="L444">        private final @Nonnull List&lt;CharBuffer&gt; multipleResult = new ArrayList&lt;&gt;(1);</span>

        MultipleSizeHandler(@Nonnull CharTransformer transformer, int size) throws IllegalArgumentException {
<span class="fc" id="L447">            super(transformer, size);</span>
<span class="fc" id="L448">        }</span>

        @Override
        protected @Nullable List&lt;CharBuffer&gt; handleMultiple(@Nonnull CharBuffer data, boolean end) throws Exception {
<span class="fc" id="L452">            int remainingSize = data.remaining();</span>
<span class="fc" id="L453">            int multipleSize = remainingSize / size * size;</span>
<span class="fc bfc" id="L454" title="All 2 branches covered.">            if (multipleSize &lt;= 0) {</span>
<span class="fc" id="L455">                return null;</span>
            }
<span class="fc" id="L457">            CharBuffer multiple = BufferKit.slice0(data, 0, multipleSize);</span>
<span class="fc" id="L458">            data.position(data.position() + multipleSize);</span>
<span class="fc bfc" id="L459" title="All 4 branches covered.">            CharBuffer multipleRet = transformer.transform(</span>
                multiple,
                end &amp;&amp; multipleSize == remainingSize
            );
<span class="fc" id="L463">            multipleResult.add(multipleRet);</span>
<span class="fc" id="L464">            return multipleResult;</span>
        }
    }

    static final class BufferedHandler implements CharTransformer {

        private final CharTransformer transformer;
<span class="fc" id="L471">        private char @Nullable [] buffer = null;</span>

<span class="fc" id="L473">        BufferedHandler(CharTransformer transformer) {</span>
<span class="fc" id="L474">            this.transformer = transformer;</span>
<span class="fc" id="L475">        }</span>

        @Override
        public @Nullable CharBuffer transform(@Nonnull CharBuffer data, boolean end) throws Exception {
            CharBuffer totalBuffer;
<span class="fc bfc" id="L480" title="All 2 branches covered.">            if (buffer != null) {</span>
<span class="fc" id="L481">                CharBuffer newBuffer = CharBuffer.allocate(buffer.length + data.remaining());</span>
<span class="fc" id="L482">                newBuffer.put(buffer);</span>
<span class="fc" id="L483">                newBuffer.put(data);</span>
<span class="fc" id="L484">                newBuffer.flip();</span>
<span class="fc" id="L485">                totalBuffer = newBuffer;</span>
<span class="fc" id="L486">            } else {</span>
<span class="fc" id="L487">                totalBuffer = data;</span>
            }
<span class="fc" id="L489">            CharBuffer ret = transformer.transform(totalBuffer, end);</span>
<span class="fc bfc" id="L490" title="All 2 branches covered.">            if (end) {</span>
<span class="fc" id="L491">                buffer = null;</span>
            } else {
<span class="fc" id="L493">                buffer = BufferKit.read(totalBuffer);</span>
            }
<span class="fc" id="L495">            return ret;</span>
        }
    }

<span class="fc" id="L499">    enum EmptyHandler implements CharTransformer {</span>

<span class="fc" id="L501">        INST;</span>

        @Override
        public CharBuffer transform(@Nonnull CharBuffer data, boolean end) {
<span class="fc" id="L505">            return data;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>