<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JdkProxyMaker.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">fs-all</a> &gt; <a href="index.source.html" class="el_package">space.sunqian.fs.dynamic.proxy.jdk</a> &gt; <span class="el_source">JdkProxyMaker.java</span></div><h1>JdkProxyMaker.java</h1><pre class="source lang-java linenums">package space.sunqian.fs.dynamic.proxy.jdk;

import space.sunqian.annotation.Nonnull;
import space.sunqian.annotation.Nullable;
import space.sunqian.annotation.RetainedParam;
import space.sunqian.annotation.ThreadSafe;
import space.sunqian.fs.Fs;
import space.sunqian.fs.base.value.Var;
import space.sunqian.fs.dynamic.proxy.ProxyException;
import space.sunqian.fs.dynamic.proxy.ProxyHandler;
import space.sunqian.fs.dynamic.proxy.ProxyInvoker;
import space.sunqian.fs.dynamic.proxy.ProxyMaker;
import space.sunqian.fs.dynamic.proxy.ProxySpec;
import space.sunqian.fs.invoke.Invocable;
import space.sunqian.fs.reflect.BytesClassLoader;
import space.sunqian.fs.reflect.ClassKit;

import java.lang.reflect.Constructor;
import java.lang.reflect.InvocationHandler;
import java.lang.reflect.Method;
import java.lang.reflect.Modifier;
import java.lang.reflect.Proxy;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * JDK dynamic proxy implementation for {@link ProxyMaker}.
 * &lt;p&gt;
 * This implementation uses {@link Proxy} to implement proxy, and that means it only supports proxy interfaces.
 *
 * @author sunqian
 */
@ThreadSafe
<span class="fc" id="L35">public class JdkProxyMaker implements ProxyMaker {</span>

<span class="fc" id="L37">    private static final @Nonnull Object @Nonnull [] EMPTY_ARGS = {};</span>

    @Override
    public @Nonnull ProxySpec make(
        @Nullable Class&lt;?&gt; proxiedClass,
        @Nonnull @RetainedParam List&lt;@Nonnull Class&lt;?&gt;&gt; interfaces,
        @Nonnull ProxyHandler proxyHandler
    ) throws ProxyException {
<span class="fc" id="L45">        Class&lt;?&gt; proxyClass = Proxy.getProxyClass(</span>
            new BytesClassLoader(),
<span class="fc" id="L47">            interfaces.toArray(new Class&lt;?&gt;[0])</span>
        );
<span class="fc" id="L49">        Map&lt;Method, Var&lt;ProxyInvoker&gt;&gt; proxiedMethods = new HashMap&lt;&gt;();</span>
<span class="fc" id="L50">        Map&lt;Method, Var&lt;Invocable&gt;&gt; unproxiedMethods = new HashMap&lt;&gt;();</span>
<span class="fc bfc" id="L51" title="All 2 branches covered.">        for (Class&lt;?&gt; anInterface : interfaces) {</span>
<span class="fc" id="L52">            Method[] methods = anInterface.getMethods();</span>
<span class="fc bfc" id="L53" title="All 2 branches covered.">            for (Method method : methods) {</span>
<span class="fc bfc" id="L54" title="All 2 branches covered.">                if (ClassKit.isStatic(method)) {</span>
<span class="fc" id="L55">                    continue;</span>
                }
<span class="fc bfc" id="L57" title="All 4 branches covered.">                if (!proxiedMethods.containsKey(method) &amp;&amp; proxyHandler.needsProxy(method)) {</span>
<span class="fc" id="L58">                    proxiedMethods.put(method, Var.of(null));</span>
                } else {
<span class="fc" id="L60">                    unproxiedMethods.put(method, Var.of(null));</span>
                }
            }
<span class="fc" id="L63">        }</span>
<span class="fc" id="L64">        InvocationHandler invocationHandler = makeInvocationHandler(</span>
            proxyHandler,
            new HashMap&lt;&gt;(proxiedMethods),
            new HashMap&lt;&gt;(unproxiedMethods)
        );
<span class="fc" id="L69">        return new JdkProxySpec(proxyClass, interfaces, proxyHandler, invocationHandler);</span>
    }

    private static @Nonnull InvocationHandler makeInvocationHandler(
        @Nonnull ProxyHandler methodHandler,
        @Nonnull Map&lt;@Nonnull Method, @Nonnull Var&lt;ProxyInvoker&gt;&gt; proxiedMap,
        @Nonnull Map&lt;@Nonnull Method, @Nonnull Var&lt;Invocable&gt;&gt; unproxiedMap
    ) {
<span class="fc" id="L77">        return (proxy, method, args) -&gt; {</span>
<span class="fc" id="L78">            Object[] nonnullArgs = Fs.nonnull(args, EMPTY_ARGS);</span>
<span class="fc" id="L79">            Var&lt;ProxyInvoker&gt; invokerVar = proxiedMap.get(method);</span>
<span class="fc bfc" id="L80" title="All 2 branches covered.">            if (invokerVar == null) {</span>
<span class="fc" id="L81">                @Nonnull Var&lt;Invocable&gt; invocableVar = unproxiedMap.get(method);</span>
<span class="fc" id="L82">                Invocable invocable = invocableVar.get();</span>
<span class="fc bfc" id="L83" title="All 2 branches covered.">                if (invocable == null) {</span>
<span class="fc" id="L84">                    invocable = buildSuperInvoker(method);</span>
<span class="fc" id="L85">                    invocableVar.set(invocable);</span>
                }
<span class="fc" id="L87">                return invocable.invokeChecked(proxy, nonnullArgs);</span>
            }
<span class="fc" id="L89">            @Nullable ProxyInvoker invoker = invokerVar.get();</span>
<span class="fc bfc" id="L90" title="All 2 branches covered.">            if (invoker == null) {</span>
<span class="fc" id="L91">                invoker = new JdkInvoker(method);</span>
<span class="fc" id="L92">                invokerVar.set(invoker);</span>
            }
<span class="fc" id="L94">            return methodHandler.invoke(proxy, method, invoker, nonnullArgs);</span>
        };
    }

    private static final class JdkInvoker implements ProxyInvoker {

        private final @Nonnull Invocable virtualInvoker;
        private final @Nonnull Invocable superInvoker;

<span class="fc" id="L103">        private JdkInvoker(Method method) throws Exception {</span>
<span class="fc" id="L104">            this.virtualInvoker = Invocable.of(method);</span>
            // if (method.is)
<span class="fc" id="L106">            this.superInvoker = buildSuperInvoker(method);</span>
<span class="fc" id="L107">        }</span>

        @Override
        public @Nullable Object invoke(@Nonnull Object inst, @Nullable Object @Nonnull ... args) throws Throwable {
<span class="fc" id="L111">            return virtualInvoker.invokeChecked(inst, args);</span>
        }

        @Override
        public @Nullable Object invokeSuper(@Nonnull Object inst, @Nullable Object @Nonnull ... args) throws Throwable {
<span class="fc" id="L116">            return superInvoker.invokeChecked(inst, args);</span>
        }
    }

    private static final class JdkProxySpec implements ProxySpec {

        private final @Nonnull Class&lt;?&gt; proxyClass;
        private final @Nonnull List&lt;@Nonnull Class&lt;?&gt;&gt; proxiedInterfaces;
        private final @Nonnull ProxyHandler proxyHandler;
        private final @Nonnull InvocationHandler invocationHandler;

        private JdkProxySpec(
            @Nonnull Class&lt;?&gt; proxyClass,
            @Nonnull List&lt;@Nonnull Class&lt;?&gt;&gt; proxiedInterfaces,
            @Nonnull ProxyHandler proxyHandler,
            @Nonnull InvocationHandler invocationHandler
<span class="fc" id="L132">        ) {</span>
<span class="fc" id="L133">            this.proxyClass = proxyClass;</span>
<span class="fc" id="L134">            this.proxiedInterfaces = proxiedInterfaces;</span>
<span class="fc" id="L135">            this.proxyHandler = proxyHandler;</span>
<span class="fc" id="L136">            this.invocationHandler = invocationHandler;</span>
<span class="fc" id="L137">        }</span>

        @Override
        public &lt;T&gt; @Nonnull T newInstance() throws JdkProxyException {
<span class="fc" id="L141">            return Fs.uncheck(() -&gt; {</span>
<span class="fc" id="L142">                Constructor&lt;?&gt; constructor = proxyClass.getConstructor(InvocationHandler.class);</span>
<span class="fc" id="L143">                return Fs.as(constructor.newInstance(invocationHandler));</span>
            }, JdkProxyException::new);
        }

        @Override
        public @Nonnull Class&lt;?&gt; proxyClass() {
<span class="fc" id="L149">            return proxyClass;</span>
        }

        @Override
        public @Nonnull Class&lt;?&gt; proxiedClass() {
<span class="fc" id="L154">            return Object.class;</span>
        }

        @Override
        public @Nonnull List&lt;@Nonnull Class&lt;?&gt;&gt; proxiedInterfaces() {
<span class="fc" id="L159">            return proxiedInterfaces;</span>
        }

        @Override
        public @Nonnull ProxyHandler proxyHandler() {
<span class="fc" id="L164">            return proxyHandler;</span>
        }
    }

    private static @Nonnull Invocable buildSuperInvoker(@Nonnull Method method) throws Exception {
<span class="fc bfc" id="L169" title="All 2 branches covered.">        if (Modifier.isAbstract(method.getModifiers())) {</span>
<span class="fc" id="L170">            return (inst, args) -&gt; {</span>
<span class="fc" id="L171">                throw new AbstractMethodError(method.toString());</span>
            };
        }
<span class="fc" id="L174">        return DefaultMethodService.INST.getDefaultMethodInvocable(method);</span>
    }

    /**
     * This exception is the sub-exception of {@link ProxyException} for JDK dynamic proxy implementation.
     *
     * @author sunqian
     */
    public static class JdkProxyException extends ProxyException {
        /**
         * Constructs with the cause.
         *
         * @param cause the cause
         */
        public JdkProxyException(@Nullable Throwable cause) {
<span class="fc" id="L189">            super(cause);</span>
<span class="fc" id="L190">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>