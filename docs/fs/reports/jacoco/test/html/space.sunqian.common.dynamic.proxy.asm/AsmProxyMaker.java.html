<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AsmProxyMaker.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">fs-all</a> &gt; <a href="index.source.html" class="el_package">space.sunqian.common.dynamic.proxy.asm</a> &gt; <span class="el_source">AsmProxyMaker.java</span></div><h1>AsmProxyMaker.java</h1><pre class="source lang-java linenums">package space.sunqian.common.dynamic.proxy.asm;

import org.objectweb.asm.ClassWriter;
import org.objectweb.asm.FieldVisitor;
import org.objectweb.asm.Label;
import org.objectweb.asm.MethodVisitor;
import org.objectweb.asm.Opcodes;
import space.sunqian.annotations.Nonnull;
import space.sunqian.annotations.Nullable;
import space.sunqian.annotations.RetainedParam;
import space.sunqian.annotations.ThreadSafe;
import space.sunqian.common.Fs;
import space.sunqian.common.base.system.JvmKit;
import space.sunqian.common.base.value.IntVar;
import space.sunqian.common.dynamic.proxy.ProxyException;
import space.sunqian.common.dynamic.proxy.ProxyHandler;
import space.sunqian.common.dynamic.proxy.ProxyInvoker;
import space.sunqian.common.dynamic.proxy.ProxyKit;
import space.sunqian.common.dynamic.proxy.ProxyMaker;
import space.sunqian.common.dynamic.proxy.ProxySpec;
import space.sunqian.common.reflect.BytesClassLoader;
import space.sunqian.common.reflect.ClassKit;
import space.sunqian.common.third.asm.AsmKit;

import java.lang.reflect.Constructor;
import java.lang.reflect.Executable;
import java.lang.reflect.Method;
import java.lang.reflect.Parameter;
import java.util.ArrayList;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.Map;
import java.util.concurrent.atomic.AtomicLong;

/**
 * The &lt;a href=&quot;https://asm.ow2.io/&quot;&gt;ASM&lt;/a&gt; implementation for {@link ProxyMaker}. The runtime environment must have
 * asm package {@code org.objectweb.asm}.
 * &lt;p&gt;
 * This implementation uses inheritance to implement proxy, just like the keywords: {@code extends} and
 * {@code implements}. That means the superclass, which is the proxied class, cannot be {@code final} and must be
 * inheritable, and must have an empty constructor to ensure that the {@link ProxySpec#newInstance()} can execute
 * correctly.
 * &lt;p&gt;
 * When the {@link #make(Class, List, ProxyHandler)} is called, and if there are methods with the same name and JVM
 * descriptor, this implementation only passes the first one encountered to the
 * {@link ProxyHandler#needsProxy(Method)}.
 * &lt;p&gt;
 * Note the generated proxy class is {@code final}.
 *
 * @author sunqian
 */
@ThreadSafe
<span class="fc" id="L53">public class AsmProxyMaker implements ProxyMaker {</span>

<span class="fc" id="L55">    private static final @Nonnull String INVOKER_NAME = JvmKit.toInternalName(ProxyInvoker.class);</span>
<span class="fc" id="L56">    private static final @Nonnull String INVOKERS_DESCRIPTOR = JvmKit.toDescriptor(ProxyInvoker[].class);</span>
<span class="fc" id="L57">    private static final @Nonnull String HANDLER_NAME = JvmKit.toInternalName(ProxyHandler.class);</span>
<span class="fc" id="L58">    private static final @Nonnull String HANDLER_DESCRIPTOR = JvmKit.toDescriptor(ProxyHandler.class);</span>
<span class="fc" id="L59">    private static final @Nonnull String METHODS_DESCRIPTOR = JvmKit.toDescriptor(Method[].class);</span>
    private static final @Nonnull String INVOKER_SIMPLE_NAME = &quot;AsmInvoker&quot;;
    private static final @Nonnull String SUPER_INVOKER_NAME_PREFIX = &quot;access$super$&quot;;
<span class="fc" id="L62">    private static final @Nonnull Method HANDLER_INVOKE = Fs.uncheck(</span>
<span class="fc" id="L63">        () -&gt; ProxyHandler.class.getMethod(&quot;invoke&quot;, Object.class, Method.class, ProxyInvoker.class, Object[].class),</span>
        AsmProxyException::new
    );
<span class="fc" id="L66">    private static final @Nonnull String HANDLER_INVOKE_DESCRIPTOR = JvmKit.toDescriptor(HANDLER_INVOKE);</span>
<span class="fc" id="L67">    private static final @Nonnull Method INVOKER_INVOKE = Fs.uncheck(</span>
<span class="fc" id="L68">        () -&gt; ProxyInvoker.class.getMethod(&quot;invoke&quot;, Object.class, Object[].class),</span>
        AsmProxyException::new
    );
<span class="fc" id="L71">    private static final @Nonnull String INVOKER_INVOKE_DESCRIPTOR = JvmKit.toDescriptor(INVOKER_INVOKE);</span>
<span class="fc" id="L72">    private static final @Nonnull String @Nullable [] INVOKER_INVOKE_EXCEPTIONS = AsmKit.getExceptions(INVOKER_INVOKE);</span>
<span class="fc" id="L73">    private static final @Nonnull Method INVOKER_INVOKE_SUPER = Fs.uncheck(</span>
<span class="fc" id="L74">        () -&gt; ProxyInvoker.class.getMethod(&quot;invokeSuper&quot;, Object.class, Object[].class),</span>
        AsmProxyException::new
    );
<span class="fc" id="L77">    private static final @Nonnull String INVOKER_INVOKE_SUPER_DESCRIPTOR = JvmKit.toDescriptor(INVOKER_INVOKE_SUPER);</span>
<span class="fc" id="L78">    private static final @Nonnull String @Nullable [] INVOKER_INVOKE_SUPER_EXCEPTIONS = AsmKit.getExceptions(INVOKER_INVOKE_SUPER);</span>

<span class="fc" id="L80">    private static final @Nonnull AtomicLong classCounter = new AtomicLong();</span>

    @Override
    public @Nonnull ProxySpec make(
        @Nullable Class&lt;?&gt; proxiedClass,
        @Nonnull @RetainedParam List&lt;@Nonnull Class&lt;?&gt;&gt; interfaces,
        @Nonnull ProxyHandler proxyHandler
    ) throws AsmProxyException {
        try {
<span class="fc" id="L89">            Package pkg = AsmProxyMaker.class.getPackage();</span>
            // proxy class internal name
<span class="fc" id="L91">            String proxyName = pkg.getName().replace('.', '/')</span>
<span class="fc" id="L92">                + &quot;/&quot; + AsmKit.generateClassSimpleName(classCounter.incrementAndGet());</span>
            // proxy class descriptor
<span class="fc" id="L94">            String proxyDescriptor = &quot;L&quot; + proxyName + &quot;;&quot;;</span>
            // proxy class's superclass, which is the proxied class
<span class="fc bfc" id="L96" title="All 2 branches covered.">            Class&lt;?&gt; proxySuperClass = proxiedClass == null ? Object.class : proxiedClass;</span>
<span class="fc" id="L97">            String proxySuperName = JvmKit.toInternalName(proxySuperClass);</span>
            // proxy class's interfaces, which is the proxied interfaces
<span class="fc" id="L99">            String[] proxyInterfaces = {};</span>
<span class="fc bfc" id="L100" title="All 2 branches covered.">            if (!interfaces.isEmpty()) {</span>
<span class="fc" id="L101">                proxyInterfaces = interfaces.stream().map(JvmKit::toInternalName).toArray(String[]::new);</span>
            }
            // ProxyInvoker's class internal name (inner class's simple name)
<span class="fc" id="L104">            String invokerSimpleName = INVOKER_SIMPLE_NAME;</span>
<span class="fc" id="L105">            String invokerName = proxyName + &quot;$&quot; + invokerSimpleName;</span>
            // proxied methods
<span class="fc" id="L107">            Map&lt;Method, ProxyMethodInfo&gt; proxiedMethodMap = new LinkedHashMap&lt;&gt;();</span>
<span class="fc" id="L108">            Map&lt;Class&lt;?&gt;, List&lt;Method&gt;&gt; proxiableMethods = ProxyKit.getProxiableMethods(</span>
                proxiedClass,
                interfaces,
                proxyHandler
            );
<span class="fc" id="L113">            IntVar methodCount = IntVar.of(0);</span>
<span class="fc" id="L114">            proxiableMethods.forEach((type, methods) -&gt; {</span>
<span class="fc" id="L115">                String ownerName = JvmKit.toInternalName(type);</span>
<span class="fc bfc" id="L116" title="All 2 branches covered.">                for (Method method : methods) {</span>
<span class="fc" id="L117">                    proxiedMethodMap.put(</span>
                        method,
<span class="fc" id="L119">                        buildProxyMethodInfo(</span>
                            method,
                            ownerName,
                            proxyDescriptor,
<span class="fc" id="L123">                            type.isInterface(),</span>
<span class="fc" id="L124">                            methodCount.getAndIncrement()</span>
                        )
                    );
<span class="fc" id="L127">                }</span>
<span class="fc" id="L128">            });</span>
<span class="fc" id="L129">            ProxyClassInfo pcInfo = new ProxyClassInfo(</span>
                proxyName,
                proxyDescriptor,
                proxySuperName,
                proxyInterfaces,
                invokerSimpleName,
                invokerName,
<span class="fc" id="L136">                new ArrayList&lt;&gt;(proxiedMethodMap.values())</span>
            );
<span class="fc" id="L138">            byte[] proxyClassBytes = generateProxyClass(pcInfo);</span>
<span class="fc" id="L139">            byte[] invokerClassBytes = generateInvokerClass(pcInfo);</span>
            // using new class loader to help collect unused classes
<span class="fc" id="L141">            BytesClassLoader loader = ClassKit.newClassLoader();</span>
<span class="fc" id="L142">            Class&lt;?&gt; proxyClass = loader.loadClass(null, proxyClassBytes);</span>
<span class="fc" id="L143">            loader.loadClass(null, invokerClassBytes);</span>
<span class="fc" id="L144">            return new AsmProxySpec(</span>
                proxyClass,
                proxySuperClass,
                interfaces,
                proxyHandler,
<span class="fc" id="L149">                proxiedMethodMap.keySet().toArray(new Method[0])</span>
            );
<span class="fc" id="L151">        } catch (Exception e) {</span>
<span class="fc" id="L152">            throw new AsmProxyException(e);</span>
        }
    }

    private @Nonnull ProxyMethodInfo buildProxyMethodInfo(
        @Nonnull Method method,
        @Nonnull String ownerName,
        @Nonnull String proxyDescriptor,
        boolean isInterface,
        int methodIndex
    ) {
<span class="fc" id="L163">        String descriptor = JvmKit.toDescriptor(method);</span>
<span class="fc" id="L164">        String signature = JvmKit.toSignature(method);</span>
<span class="fc" id="L165">        String[] exceptions = AsmKit.getExceptions(method);</span>
<span class="fc" id="L166">        String superInvokerName = SUPER_INVOKER_NAME_PREFIX + methodIndex;// access$001</span>
<span class="fc" id="L167">        String superInvokerDescriptor = descriptor.replace(&quot;(&quot;, &quot;(&quot; + proxyDescriptor);</span>
<span class="fc bfc" id="L168" title="All 2 branches covered.">        String superInvokerSignature =</span>
<span class="fc" id="L169">            signature == null ? null : signature.replace(&quot;(&quot;, &quot;(&quot; + proxyDescriptor);</span>
<span class="fc" id="L170">        return new ProxyMethodInfo(</span>
            method,
            ownerName,
            descriptor,
            signature,
            exceptions,
            superInvokerName,
            superInvokerDescriptor,
            superInvokerSignature,
            isInterface
        );
    }

    private byte @Nonnull [] generateProxyClass(@Nonnull ProxyClassInfo pcInfo) throws Exception {
<span class="fc" id="L184">        ClassWriter classWriter = new ClassWriter(ClassWriter.COMPUTE_MAXS);</span>
<span class="fc" id="L185">        classWriter.visit(</span>
            Opcodes.V1_8,
            Opcodes.ACC_PUBLIC | Opcodes.ACC_FINAL | Opcodes.ACC_SUPER,
<span class="fc" id="L188">            pcInfo.proxyName,</span>
            null,
<span class="fc" id="L190">            pcInfo.proxySuperName,</span>
<span class="fc" id="L191">            pcInfo.proxyInterfaces</span>
        );
<span class="fc" id="L193">        classWriter.visitInnerClass(</span>
<span class="fc" id="L194">            pcInfo.innerName,</span>
<span class="fc" id="L195">            pcInfo.proxyName,</span>
<span class="fc" id="L196">            pcInfo.innerSimpleName,</span>
            Opcodes.ACC_PRIVATE
        );
        {
<span class="fc" id="L200">            FieldVisitor visitor = classWriter.visitField(</span>
                Opcodes.ACC_PRIVATE | Opcodes.ACC_FINAL,
                &quot;handler&quot;,
                HANDLER_DESCRIPTOR,
                null,
                null
            );
<span class="fc" id="L207">            visitor.visitEnd();</span>
        }
        {
<span class="fc" id="L210">            FieldVisitor visitor = classWriter.visitField(</span>
                Opcodes.ACC_PRIVATE | Opcodes.ACC_FINAL,
                &quot;methods&quot;,
                METHODS_DESCRIPTOR,
                null,
                null
            );
<span class="fc" id="L217">            visitor.visitEnd();</span>
        }
        {
<span class="fc" id="L220">            FieldVisitor visitor = classWriter.visitField(</span>
                Opcodes.ACC_PRIVATE | Opcodes.ACC_FINAL,
                &quot;invokers&quot;,
                INVOKERS_DESCRIPTOR,
                null,
                null
            );
<span class="fc" id="L227">            visitor.visitEnd();</span>
        }
        {
<span class="fc" id="L230">            MethodVisitor visitor = classWriter.visitMethod(</span>
                Opcodes.ACC_PUBLIC,
                AsmKit.CONSTRUCTOR_NAME,
                &quot;(&quot; + HANDLER_DESCRIPTOR + METHODS_DESCRIPTOR + &quot;)V&quot;,
                null,
                null
            );
<span class="fc" id="L237">            visitor.visitVarInsn(Opcodes.ALOAD, 0);</span>
<span class="fc" id="L238">            visitor.visitMethodInsn(</span>
                Opcodes.INVOKESPECIAL,
<span class="fc" id="L240">                pcInfo.proxySuperName,</span>
                AsmKit.CONSTRUCTOR_NAME,
                AsmKit.EMPTY_CONSTRUCTOR_DESCRIPTOR,
                false
            );
<span class="fc" id="L245">            visitor.visitVarInsn(Opcodes.ALOAD, 0);</span>
<span class="fc" id="L246">            visitor.visitVarInsn(Opcodes.ALOAD, 1);</span>
<span class="fc" id="L247">            visitor.visitFieldInsn(Opcodes.PUTFIELD, pcInfo.proxyName, &quot;handler&quot;, HANDLER_DESCRIPTOR);</span>
<span class="fc" id="L248">            visitor.visitVarInsn(Opcodes.ALOAD, 0);</span>
<span class="fc" id="L249">            visitor.visitVarInsn(Opcodes.ALOAD, 2);</span>
<span class="fc" id="L250">            visitor.visitFieldInsn(Opcodes.PUTFIELD, pcInfo.proxyName, &quot;methods&quot;, METHODS_DESCRIPTOR);</span>
<span class="fc" id="L251">            visitor.visitVarInsn(Opcodes.ALOAD, 0);</span>
<span class="fc" id="L252">            visitor.visitVarInsn(Opcodes.ALOAD, 2);</span>
<span class="fc" id="L253">            visitor.visitInsn(Opcodes.ARRAYLENGTH);</span>
<span class="fc" id="L254">            visitor.visitTypeInsn(Opcodes.ANEWARRAY, INVOKER_NAME);</span>
<span class="fc" id="L255">            visitor.visitFieldInsn(Opcodes.PUTFIELD, pcInfo.proxyName, &quot;invokers&quot;, INVOKERS_DESCRIPTOR);</span>
<span class="fc" id="L256">            visitor.visitInsn(Opcodes.RETURN);</span>
<span class="fc" id="L257">            visitor.visitMaxs(0, 0);</span>
<span class="fc" id="L258">            visitor.visitEnd();</span>
        }
<span class="fc" id="L260">        int i = 0;</span>
<span class="fc bfc" id="L261" title="All 2 branches covered.">        for (ProxyMethodInfo pmInfo : pcInfo.methods) {</span>
<span class="fc" id="L262">            generateProxyMethod(classWriter, pcInfo, pmInfo, i);</span>
<span class="fc" id="L263">            generateSuperInvoker(classWriter, pmInfo);</span>
<span class="fc" id="L264">            i++;</span>
<span class="fc" id="L265">        }</span>
<span class="fc" id="L266">        classWriter.visitEnd();</span>
<span class="fc" id="L267">        return classWriter.toByteArray();</span>
    }

    private void generateProxyMethod(
        @Nonnull ClassWriter classWriter,
        @Nonnull ProxyClassInfo pcInfo,
        @Nonnull ProxyMethodInfo pmInfo,
        int i
    ) throws Exception {
<span class="fc" id="L276">        MethodVisitor visitor = classWriter.visitMethod(</span>
            Opcodes.ACC_PUBLIC,
<span class="fc" id="L278">            pmInfo.method.getName(),</span>
<span class="fc" id="L279">            pmInfo.descriptor,</span>
<span class="fc" id="L280">            pmInfo.signature,</span>
<span class="fc" id="L281">            pmInfo.exceptions</span>
        );
        // ProxyInvoker invoker = invokers[i];
<span class="fc" id="L284">        visitor.visitVarInsn(Opcodes.ALOAD, 0);</span>
<span class="fc" id="L285">        visitor.visitFieldInsn(Opcodes.GETFIELD, pcInfo.proxyName, &quot;invokers&quot;, INVOKERS_DESCRIPTOR);</span>
<span class="fc" id="L286">        AsmKit.visitConst(visitor, i);</span>
<span class="fc" id="L287">        visitor.visitInsn(Opcodes.AALOAD);</span>
<span class="fc" id="L288">        int invokerPos = AsmKit.paramSize(pmInfo.method.getParameters()) + 1;</span>
<span class="fc" id="L289">        visitor.visitVarInsn(Opcodes.ASTORE, invokerPos);</span>
<span class="fc" id="L290">        visitor.visitVarInsn(Opcodes.ALOAD, invokerPos);</span>
        // if (invoker == null)
<span class="fc" id="L292">        Label ifNonnull = new Label();</span>
<span class="fc" id="L293">        visitor.visitJumpInsn(Opcodes.IFNONNULL, ifNonnull);</span>
        // new Invoker1(i);
<span class="fc" id="L295">        visitor.visitTypeInsn(Opcodes.NEW, pcInfo.innerName);</span>
        // new Invoker1(i).init();
<span class="fc" id="L297">        visitor.visitInsn(Opcodes.DUP);</span>
<span class="fc" id="L298">        visitor.visitVarInsn(Opcodes.ALOAD, 0);</span>
<span class="fc" id="L299">        AsmKit.visitConst(visitor, i);</span>
<span class="fc" id="L300">        visitor.visitMethodInsn(</span>
            Opcodes.INVOKESPECIAL,
<span class="fc" id="L302">            pcInfo.innerName,</span>
            AsmKit.CONSTRUCTOR_NAME,
<span class="fc" id="L304">            &quot;(&quot; + pcInfo.proxyDescriptor + &quot;I)V&quot;,</span>
            false
        );
<span class="fc" id="L307">        visitor.visitVarInsn(Opcodes.ASTORE, invokerPos);</span>
        // get invokers
<span class="fc" id="L309">        visitor.visitVarInsn(Opcodes.ALOAD, 0);</span>
<span class="fc" id="L310">        visitor.visitFieldInsn(Opcodes.GETFIELD, pcInfo.proxyName, &quot;invokers&quot;, INVOKERS_DESCRIPTOR);</span>
        // invokers[i] = invoker;
<span class="fc" id="L312">        AsmKit.visitConst(visitor, i);</span>
<span class="fc" id="L313">        visitor.visitVarInsn(Opcodes.ALOAD, invokerPos);</span>
<span class="fc" id="L314">        visitor.visitInsn(Opcodes.AASTORE);</span>
        // endif
<span class="fc" id="L316">        visitor.visitLabel(ifNonnull);</span>
<span class="fc" id="L317">        visitor.visitFrame(Opcodes.F_APPEND, 1, new String[]{INVOKER_NAME}, 0, null);</span>
        // get handler
<span class="fc" id="L319">        visitor.visitVarInsn(Opcodes.ALOAD, 0);</span>
<span class="fc" id="L320">        visitor.visitFieldInsn(Opcodes.GETFIELD, pcInfo.proxyName, &quot;handler&quot;, HANDLER_DESCRIPTOR);</span>
        // get this
<span class="fc" id="L322">        visitor.visitVarInsn(Opcodes.ALOAD, 0);</span>
        // get methods[i]
<span class="fc" id="L324">        visitor.visitVarInsn(Opcodes.ALOAD, 0);</span>
<span class="fc" id="L325">        visitor.visitFieldInsn(Opcodes.GETFIELD, pcInfo.proxyName, &quot;methods&quot;, METHODS_DESCRIPTOR);</span>
<span class="fc" id="L326">        AsmKit.visitConst(visitor, i);</span>
<span class="fc" id="L327">        visitor.visitInsn(Opcodes.AALOAD);</span>
        // get invoker
<span class="fc" id="L329">        visitor.visitVarInsn(Opcodes.ALOAD, invokerPos);</span>
        // new Object[params.size]
<span class="fc" id="L331">        AsmKit.visitConst(visitor, pmInfo.method.getParameterCount());</span>
<span class="fc" id="L332">        visitor.visitTypeInsn(Opcodes.ANEWARRAY, AsmKit.OBJECT_NAME);</span>
        // set array
<span class="fc" id="L334">        int aIndex = 0;</span>
<span class="fc" id="L335">        int pIndex = 1;</span>
<span class="fc bfc" id="L336" title="All 2 branches covered.">        for (Parameter parameter : pmInfo.method.getParameters()) {</span>
            // array[i] = param[i]
<span class="fc" id="L338">            visitor.visitInsn(Opcodes.DUP);</span>
<span class="fc" id="L339">            AsmKit.visitConst(visitor, aIndex++);</span>
<span class="fc" id="L340">            AsmKit.visitLoad(visitor, parameter.getType(), pIndex);</span>
<span class="fc" id="L341">            AsmKit.wrapToObject(visitor, parameter.getType());</span>
<span class="fc" id="L342">            visitor.visitInsn(Opcodes.AASTORE);</span>
<span class="fc" id="L343">            pIndex += AsmKit.varSize(parameter.getType());</span>
        }
        // return handler.invoke(this, methods[0], invoker, args);
<span class="fc" id="L346">        visitor.visitMethodInsn(</span>
            Opcodes.INVOKEINTERFACE,
            HANDLER_NAME,
<span class="fc" id="L349">            HANDLER_INVOKE.getName(),</span>
            HANDLER_INVOKE_DESCRIPTOR,
            true
        );
        // object -&gt; primitive/object
<span class="fc" id="L354">        AsmKit.convertObjectTo(visitor, pmInfo.method.getReturnType());</span>
<span class="fc" id="L355">        AsmKit.visitReturn(visitor, pmInfo.method.getReturnType(), true, false);</span>
<span class="fc" id="L356">        visitor.visitMaxs(0, 0);</span>
<span class="fc" id="L357">        visitor.visitEnd();</span>
<span class="fc" id="L358">    }</span>

    private void generateSuperInvoker(
        @Nonnull ClassWriter classWriter,
        @Nonnull ProxyMethodInfo pmInfo
    ) {
<span class="fc" id="L364">        MethodVisitor visitor = classWriter.visitMethod(</span>
            Opcodes.ACC_STATIC | Opcodes.ACC_SYNTHETIC,
<span class="fc" id="L366">            pmInfo.superInvokerName,</span>
<span class="fc" id="L367">            pmInfo.superInvokerDescriptor,</span>
<span class="fc" id="L368">            pmInfo.superInvokerSignature,</span>
<span class="fc" id="L369">            pmInfo.exceptions</span>
        );
<span class="fc" id="L371">        visitor.visitVarInsn(Opcodes.ALOAD, 0);</span>
<span class="fc" id="L372">        int pIndex = 1;</span>
<span class="fc bfc" id="L373" title="All 2 branches covered.">        for (Parameter parameter : pmInfo.method.getParameters()) {</span>
<span class="fc" id="L374">            AsmKit.visitLoad(visitor, parameter.getType(), pIndex);</span>
<span class="fc" id="L375">            pIndex += AsmKit.varSize(parameter.getType());</span>
        }
<span class="fc" id="L377">        visitor.visitMethodInsn(</span>
            Opcodes.INVOKESPECIAL,
<span class="fc" id="L379">            pmInfo.ownerName,</span>
<span class="fc" id="L380">            pmInfo.method.getName(),</span>
<span class="fc" id="L381">            pmInfo.descriptor,</span>
<span class="fc" id="L382">            pmInfo.isInterface</span>
        );
<span class="fc" id="L384">        AsmKit.visitReturn(visitor, pmInfo.method.getReturnType(), false, false);</span>
<span class="fc" id="L385">        visitor.visitMaxs(0, 0);</span>
<span class="fc" id="L386">        visitor.visitEnd();</span>
<span class="fc" id="L387">    }</span>

    private byte @Nonnull [] generateInvokerClass(@Nonnull ProxyClassInfo pcInfo) {
<span class="fc" id="L390">        ClassWriter classWriter = new ClassWriter(ClassWriter.COMPUTE_MAXS);</span>
<span class="fc" id="L391">        classWriter.visit(</span>
            Opcodes.V1_8,
            Opcodes.ACC_FINAL | Opcodes.ACC_SUPER,
<span class="fc" id="L394">            pcInfo.innerName,</span>
            null,
            AsmKit.OBJECT_NAME,
            new String[]{INVOKER_NAME}
        );
<span class="fc" id="L399">        classWriter.visitInnerClass(</span>
<span class="fc" id="L400">            pcInfo.innerName,</span>
<span class="fc" id="L401">            pcInfo.proxyName,</span>
<span class="fc" id="L402">            pcInfo.innerSimpleName,</span>
            Opcodes.ACC_PRIVATE
        );
        {
            // int index;
<span class="fc" id="L407">            FieldVisitor visitor = classWriter.visitField(</span>
                Opcodes.ACC_PRIVATE | Opcodes.ACC_FINAL,
                &quot;index&quot;,
                &quot;I&quot;,
                null,
                null
            );
<span class="fc" id="L414">            visitor.visitEnd();</span>
        }
        {
            // outer class, which is the proxy class;
<span class="fc" id="L418">            FieldVisitor visitor = classWriter.visitField(</span>
                Opcodes.ACC_FINAL | Opcodes.ACC_SYNTHETIC,
                &quot;this$0&quot;,
<span class="fc" id="L421">                pcInfo.proxyDescriptor,</span>
                null,
                null);
<span class="fc" id="L424">            visitor.visitEnd();</span>
        }
        {
            // constructor
<span class="fc" id="L428">            MethodVisitor visitor = classWriter.visitMethod(</span>
                0,
                AsmKit.CONSTRUCTOR_NAME,
<span class="fc" id="L431">                &quot;(&quot; + pcInfo.proxyDescriptor + &quot;I)V&quot;,</span>
                null,
                null
            );
<span class="fc" id="L435">            visitor.visitVarInsn(Opcodes.ALOAD, 0);</span>
<span class="fc" id="L436">            visitor.visitVarInsn(Opcodes.ALOAD, 1);</span>
<span class="fc" id="L437">            visitor.visitFieldInsn(Opcodes.PUTFIELD, pcInfo.innerName, &quot;this$0&quot;, pcInfo.proxyDescriptor);</span>
<span class="fc" id="L438">            visitor.visitVarInsn(Opcodes.ALOAD, 0);</span>
<span class="fc" id="L439">            visitor.visitMethodInsn(</span>
                Opcodes.INVOKESPECIAL,
                AsmKit.OBJECT_NAME,
                AsmKit.CONSTRUCTOR_NAME,
                AsmKit.EMPTY_CONSTRUCTOR_DESCRIPTOR,
                false
            );
<span class="fc" id="L446">            visitor.visitVarInsn(Opcodes.ALOAD, 0);</span>
<span class="fc" id="L447">            visitor.visitVarInsn(Opcodes.ILOAD, 2);</span>
<span class="fc" id="L448">            visitor.visitFieldInsn(Opcodes.PUTFIELD, pcInfo.innerName, &quot;index&quot;, &quot;I&quot;);</span>
<span class="fc" id="L449">            visitor.visitInsn(Opcodes.RETURN);</span>
<span class="fc" id="L450">            visitor.visitMaxs(0, 0);</span>
<span class="fc" id="L451">            visitor.visitEnd();</span>
        }
        {
            // invoke(Object inst, Object... args);
<span class="fc" id="L455">            MethodVisitor visitor = classWriter.visitMethod(</span>
                Opcodes.ACC_PUBLIC | Opcodes.ACC_VARARGS,
<span class="fc" id="L457">                INVOKER_INVOKE.getName(),</span>
                INVOKER_INVOKE_DESCRIPTOR,
                null,
                INVOKER_INVOKE_EXCEPTIONS
            );
            // get index;
<span class="fc" id="L463">            visitor.visitVarInsn(Opcodes.ALOAD, 0);</span>
<span class="fc" id="L464">            visitor.visitFieldInsn(Opcodes.GETFIELD, pcInfo.innerName, &quot;index&quot;, &quot;I&quot;);</span>
            // switch (index) {}
<span class="fc" id="L466">            Label[] labels = new Label[pcInfo.methods.size()];</span>
<span class="fc bfc" id="L467" title="All 2 branches covered.">            for (int i = 0; i &lt; labels.length; i++) {</span>
<span class="fc" id="L468">                labels[i] = new Label();</span>
            }
<span class="fc" id="L470">            Label labelLast = new Label();</span>
<span class="fc" id="L471">            visitor.visitTableSwitchInsn(0, pcInfo.methods.size() - 1, labelLast, labels);</span>
<span class="fc" id="L472">            int i = 0;</span>
<span class="fc bfc" id="L473" title="All 2 branches covered.">            for (ProxyMethodInfo pmInfo : pcInfo.methods) {</span>
<span class="fc" id="L474">                Method method = pmInfo.method;</span>
<span class="fc" id="L475">                String methodOwnerName = pmInfo.ownerName;</span>
<span class="fc bfc" id="L476" title="All 2 branches covered.">                if (ClassKit.isProtected(method)) {</span>
<span class="fc" id="L477">                    methodOwnerName = pcInfo.proxyName;</span>
                }
<span class="fc" id="L479">                visitor.visitLabel(labels[i++]);</span>
<span class="fc" id="L480">                visitor.visitFrame(Opcodes.F_SAME, 0, null, 0, null);</span>
                // get outer
<span class="fc" id="L482">                visitor.visitVarInsn(Opcodes.ALOAD, 1);</span>
<span class="fc" id="L483">                visitor.visitTypeInsn(Opcodes.CHECKCAST, methodOwnerName);</span>
                // loads args
<span class="fc" id="L485">                loadParameters(visitor, pmInfo.method);</span>
                // return outer.invoke(args0, args1...);
<span class="fc" id="L487">                AsmKit.invokeVirtual(</span>
<span class="fc" id="L488">                    visitor, methodOwnerName, method.getName(), pmInfo.descriptor, pmInfo.isInterface</span>
                );
<span class="fc" id="L490">                Class&lt;?&gt; returnType = AsmKit.wrapToObject(visitor, method.getReturnType());</span>
<span class="fc" id="L491">                AsmKit.visitReturn(visitor, returnType, false, true);</span>
<span class="fc" id="L492">            }</span>
<span class="fc" id="L493">            visitor.visitLabel(labelLast);</span>
<span class="fc" id="L494">            visitor.visitFrame(Opcodes.F_SAME, 0, null, 0, null);</span>
<span class="fc" id="L495">            visitor.visitInsn(Opcodes.ACONST_NULL);</span>
<span class="fc" id="L496">            visitor.visitInsn(Opcodes.ARETURN);</span>
<span class="fc" id="L497">            visitor.visitMaxs(0, 0);</span>
<span class="fc" id="L498">            visitor.visitEnd();</span>
        }
        {
            // invokeSuper(Object inst, Object... args);
<span class="fc" id="L502">            MethodVisitor visitor = classWriter.visitMethod(</span>
                Opcodes.ACC_PUBLIC | Opcodes.ACC_VARARGS,
<span class="fc" id="L504">                INVOKER_INVOKE_SUPER.getName(),</span>
                INVOKER_INVOKE_SUPER_DESCRIPTOR,
                null,
                INVOKER_INVOKE_SUPER_EXCEPTIONS
            );
            // get index;
<span class="fc" id="L510">            visitor.visitVarInsn(Opcodes.ALOAD, 0);</span>
<span class="fc" id="L511">            visitor.visitFieldInsn(Opcodes.GETFIELD, pcInfo.innerName, &quot;index&quot;, &quot;I&quot;);</span>
            // switch (index) {}
<span class="fc" id="L513">            Label[] labels = new Label[pcInfo.methods.size()];</span>
<span class="fc bfc" id="L514" title="All 2 branches covered.">            for (int i = 0; i &lt; labels.length; i++) {</span>
<span class="fc" id="L515">                labels[i] = new Label();</span>
            }
<span class="fc" id="L517">            Label labelLast = new Label();</span>
<span class="fc" id="L518">            visitor.visitTableSwitchInsn(0, pcInfo.methods.size() - 1, labelLast, labels);</span>
<span class="fc" id="L519">            int i = 0;</span>
<span class="fc bfc" id="L520" title="All 2 branches covered.">            for (ProxyMethodInfo pmInfo : pcInfo.methods) {</span>
<span class="fc" id="L521">                visitor.visitLabel(labels[i++]);</span>
<span class="fc" id="L522">                visitor.visitFrame(Opcodes.F_SAME, 0, null, 0, null);</span>
                // get outer
<span class="fc" id="L524">                visitor.visitVarInsn(Opcodes.ALOAD, 1);</span>
<span class="fc" id="L525">                visitor.visitTypeInsn(Opcodes.CHECKCAST, pcInfo.proxyName);</span>
                // loads args
<span class="fc" id="L527">                loadParameters(visitor, pmInfo.method);</span>
                // return outer.invoke(inst, args0, args1...);
<span class="fc" id="L529">                visitor.visitMethodInsn(</span>
                    Opcodes.INVOKESTATIC,
<span class="fc" id="L531">                    pcInfo.proxyName,</span>
<span class="fc" id="L532">                    pmInfo.superInvokerName,//&quot;access$001&quot;,</span>
<span class="fc" id="L533">                    pmInfo.superInvokerDescriptor,</span>
                    false
                );
<span class="fc" id="L536">                Class&lt;?&gt; returnType = AsmKit.wrapToObject(visitor, pmInfo.method.getReturnType());</span>
<span class="fc" id="L537">                AsmKit.visitReturn(visitor, returnType, false, true);</span>
<span class="fc" id="L538">            }</span>
<span class="fc" id="L539">            visitor.visitLabel(labelLast);</span>
<span class="fc" id="L540">            visitor.visitFrame(Opcodes.F_SAME, 0, null, 0, null);</span>
<span class="fc" id="L541">            visitor.visitInsn(Opcodes.ACONST_NULL);</span>
<span class="fc" id="L542">            visitor.visitInsn(Opcodes.ARETURN);</span>
<span class="fc" id="L543">            visitor.visitMaxs(0, 0);</span>
<span class="fc" id="L544">            visitor.visitEnd();</span>
        }
<span class="fc" id="L546">        classWriter.visitEnd();</span>
<span class="fc" id="L547">        return classWriter.toByteArray();</span>
    }

    private void loadParameters(MethodVisitor visitor, Executable executable) {
<span class="fc" id="L551">        int pIndex = 0;</span>
<span class="fc bfc" id="L552" title="All 2 branches covered.">        for (Parameter parameter : executable.getParameters()) {</span>
            // get args
<span class="fc" id="L554">            visitor.visitVarInsn(Opcodes.ALOAD, 2);</span>
<span class="fc" id="L555">            AsmKit.visitConst(visitor, pIndex++);</span>
            // get args[pIndex]
<span class="fc" id="L557">            visitor.visitInsn(Opcodes.AALOAD);</span>
<span class="fc" id="L558">            AsmKit.convertObjectTo(visitor, parameter.getType());</span>
        }
<span class="fc" id="L560">    }</span>

    private static final class ProxyClassInfo {

        private final @Nonnull String proxyName;
        private final @Nonnull String proxyDescriptor;
        private final @Nonnull String proxySuperName;
        private final @Nonnull String @Nullable [] proxyInterfaces;
        private final @Nonnull String innerSimpleName;
        private final @Nonnull String innerName;
        private final @Nonnull List&lt;ProxyMethodInfo&gt; methods;

        private ProxyClassInfo(
            @Nonnull String proxyName,
            @Nonnull String proxyDescriptor,
            @Nonnull String proxySuperName,
            @Nonnull String @Nullable [] proxyInterfaces,
            @Nonnull String innerSimpleName,
            @Nonnull String innerName,
            @Nonnull List&lt;ProxyMethodInfo&gt; methods
<span class="fc" id="L580">        ) {</span>
<span class="fc" id="L581">            this.proxyName = proxyName;</span>
<span class="fc" id="L582">            this.proxyDescriptor = proxyDescriptor;</span>
<span class="fc" id="L583">            this.proxySuperName = proxySuperName;</span>
<span class="fc" id="L584">            this.proxyInterfaces = proxyInterfaces;</span>
<span class="fc" id="L585">            this.innerSimpleName = innerSimpleName;</span>
<span class="fc" id="L586">            this.innerName = innerName;</span>
<span class="fc" id="L587">            this.methods = methods;</span>
<span class="fc" id="L588">        }</span>
    }

    private static final class ProxyMethodInfo {

        private final @Nonnull Method method;
        private final @Nonnull String ownerName;
        private final @Nonnull String descriptor;
        private final @Nullable String signature;
        private final @Nonnull String @Nullable [] exceptions;
        private final @Nonnull String superInvokerName;
        private final @Nonnull String superInvokerDescriptor;
        private final @Nullable String superInvokerSignature;
        private final boolean isInterface;

        private ProxyMethodInfo(
            @Nonnull Method method,
            @Nonnull String ownerName,
            @Nonnull String descriptor,
            @Nullable String signature,
            @Nonnull String @Nullable [] exceptions,
            @Nonnull String superInvokerName,
            @Nonnull String superInvokerDescriptor,
            @Nullable String superInvokerSignature,
            boolean isInterface
<span class="fc" id="L613">        ) {</span>
<span class="fc" id="L614">            this.method = method;</span>
<span class="fc" id="L615">            this.ownerName = ownerName;</span>
<span class="fc" id="L616">            this.descriptor = descriptor;</span>
<span class="fc" id="L617">            this.signature = signature;</span>
<span class="fc" id="L618">            this.exceptions = exceptions;</span>
<span class="fc" id="L619">            this.superInvokerName = superInvokerName;</span>
<span class="fc" id="L620">            this.superInvokerDescriptor = superInvokerDescriptor;</span>
<span class="fc" id="L621">            this.superInvokerSignature = superInvokerSignature;</span>
<span class="fc" id="L622">            this.isInterface = isInterface;</span>
<span class="fc" id="L623">        }</span>
    }

    private static final class AsmProxySpec implements ProxySpec {

        private final @Nonnull Class&lt;?&gt; proxyClass;
        private final @Nonnull Class&lt;?&gt; proxiedClass;
        private final @Nonnull List&lt;@Nonnull Class&lt;?&gt;&gt; proxiedInterfaces;
        private final @Nonnull ProxyHandler proxyHandler;
        private final @Nonnull Method @Nonnull [] methods;

        private AsmProxySpec(
            @Nonnull Class&lt;?&gt; proxyClass,
            @Nonnull Class&lt;?&gt; proxiedClass,
            @Nonnull List&lt;@Nonnull Class&lt;?&gt;&gt; proxiedInterfaces,
            @Nonnull ProxyHandler proxyHandler,
            @Nonnull Method @Nonnull [] methods
<span class="fc" id="L640">        ) {</span>
<span class="fc" id="L641">            this.proxyClass = proxyClass;</span>
<span class="fc" id="L642">            this.proxiedClass = proxiedClass;</span>
<span class="fc" id="L643">            this.proxiedInterfaces = proxiedInterfaces;</span>
<span class="fc" id="L644">            this.proxyHandler = proxyHandler;</span>
<span class="fc" id="L645">            this.methods = methods;</span>
<span class="fc" id="L646">        }</span>

        @Override
        public &lt;T&gt; @Nonnull T newInstance() throws AsmProxyException {
<span class="fc" id="L650">            return Fs.uncheck(() -&gt; {</span>
<span class="fc" id="L651">                Constructor&lt;?&gt; constructor = proxyClass.getConstructor(ProxyHandler.class, Method[].class);</span>
<span class="fc" id="L652">                return Fs.as(constructor.newInstance(proxyHandler, methods));</span>
            }, AsmProxyException::new);
        }

        @Override
        public @Nonnull Class&lt;?&gt; proxyClass() {
<span class="fc" id="L658">            return proxyClass;</span>
        }

        @Override
        public @Nonnull Class&lt;?&gt; proxiedClass() {
<span class="fc" id="L663">            return proxiedClass;</span>
        }

        @Override
        public @Nonnull List&lt;@Nonnull Class&lt;?&gt;&gt; proxiedInterfaces() {
<span class="fc" id="L668">            return proxiedInterfaces;</span>
        }

        @Override
        public @Nonnull ProxyHandler proxyHandler() {
<span class="fc" id="L673">            return proxyHandler;</span>
        }
    }

    /**
     * This exception is the sub-exception of {@link ProxyException} for &lt;a href=&quot;https://asm.ow2.io/&quot;&gt;ASM&lt;/a&gt; proxy
     * implementation.
     *
     * @author sunqian
     */
    public static class AsmProxyException extends ProxyException {
        /**
         * Constructs with the cause.
         *
         * @param cause the cause
         */
        public AsmProxyException(@Nullable Throwable cause) {
<span class="fc" id="L690">            super(cause);</span>
<span class="fc" id="L691">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>