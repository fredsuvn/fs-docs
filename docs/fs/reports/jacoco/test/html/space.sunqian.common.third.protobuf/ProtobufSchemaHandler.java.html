<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ProtobufSchemaHandler.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">fs-all</a> &gt; <a href="index.source.html" class="el_package">space.sunqian.common.third.protobuf</a> &gt; <span class="el_source">ProtobufSchemaHandler.java</span></div><h1>ProtobufSchemaHandler.java</h1><pre class="source lang-java linenums">package space.sunqian.common.third.protobuf;

import com.google.protobuf.Descriptors;
import com.google.protobuf.Message;
import com.google.protobuf.ProtocolStringList;
import space.sunqian.annotations.Nonnull;
import space.sunqian.annotations.Nullable;
import space.sunqian.common.Fs;
import space.sunqian.common.base.exception.UnsupportedEnvException;
import space.sunqian.common.base.string.StringKit;
import space.sunqian.common.object.data.ObjectProperty;
import space.sunqian.common.object.data.ObjectPropertyBase;
import space.sunqian.common.object.data.ObjectSchemaParser;
import space.sunqian.common.invoke.Invocable;
import space.sunqian.common.reflect.TypeKit;
import space.sunqian.common.reflect.TypeRef;

import java.lang.invoke.MethodHandle;
import java.lang.invoke.MethodHandles;
import java.lang.reflect.Field;
import java.lang.reflect.Method;
import java.lang.reflect.Type;
import java.util.List;
import java.util.Map;
import java.util.Objects;

/**
 * {@link ObjectSchemaParser.Handler} implementation for
 * &lt;a href=&quot;https://github.com/protocolbuffers/protobuf&quot;&gt;Protocol Buffers&lt;/a&gt;, can be quickly used through similar
 * codes:
 * &lt;pre&gt;{@code
 * ObjectSchemaParser parser = ObjectSchemaParser
 *     .defaultParser()
 *     .withFirstHandler(new ProtobufSchemaHandler());
 * }&lt;/pre&gt;
 * To use this class, the protobuf package {@code com.google.protobuf} must in the runtime environment.
 * &lt;p&gt;
 * Note:
 * &lt;ul&gt;
 *     &lt;li&gt;
 *         When {@link ProtocolStringList} is used as a property type, it will be mapped to {@code List&lt;String&gt;}, but
 *         the type of the instance returned by {@link ObjectProperty#getValue(Object)} is still
 *         {@link ProtocolStringList};
 *     &lt;/li&gt;
 *     &lt;li&gt;
 *         For a Builder, the properties of {@code repeated} and {@code map} types do not have setter methods, but the
 *         setter (which is am {@link Invocable}) is not null.
 *     &lt;/li&gt;
 * &lt;/ul&gt;
 *
 * @author sunqian
 */
public class ProtobufSchemaHandler implements ObjectSchemaParser.Handler {

<span class="fc" id="L55">    static final class StringListTypeRef extends TypeRef&lt;List&lt;String&gt;&gt; {</span>
<span class="fc" id="L56">        static final @Nonnull StringListTypeRef SINGLETON = new StringListTypeRef();</span>
    }

    /**
     * Constructs a new handler instance. This constructor will check whether the protobuf package is available in the
     * current environment.
     *
     * @throws UnsupportedEnvException if the protobuf package is not available in the current environment.
     */
<span class="fc" id="L65">    public ProtobufSchemaHandler() throws UnsupportedEnvException {</span>
<span class="fc" id="L66">        Fs.uncheck(() -&gt; Class.forName(&quot;com.google.protobuf.Message&quot;), UnsupportedEnvException::new);</span>
<span class="fc" id="L67">    }</span>

    @Override
    public boolean parse(@Nonnull ObjectSchemaParser.Context context) throws Exception {
<span class="fc" id="L71">        Class&lt;?&gt; rawType = TypeKit.getRawClass(context.dataType());</span>
<span class="fc bfc" id="L72" title="All 2 branches covered.">        if (rawType == null) {</span>
<span class="fc" id="L73">            return true;</span>
        }
        // Check whether it is a protobuf object
<span class="fc" id="L76">        boolean isProtobuf = false;</span>
<span class="fc" id="L77">        boolean isBuilder = false;</span>
<span class="fc bfc" id="L78" title="All 2 branches covered.">        if (Message.class.isAssignableFrom(rawType)) {</span>
<span class="fc" id="L79">            isProtobuf = true;</span>
        }
<span class="fc bfc" id="L81" title="All 2 branches covered.">        if (Message.Builder.class.isAssignableFrom(rawType)) {</span>
<span class="fc" id="L82">            isProtobuf = true;</span>
<span class="fc" id="L83">            isBuilder = true;</span>
        }
<span class="fc bfc" id="L85" title="All 2 branches covered.">        if (!isProtobuf) {</span>
<span class="fc" id="L86">            return true;</span>
        }
<span class="fc" id="L88">        Method getDescriptorMethod = rawType.getMethod(&quot;getDescriptor&quot;);</span>
<span class="fc" id="L89">        Descriptors.Descriptor descriptor = (Descriptors.Descriptor) getDescriptorMethod.invoke(null);</span>
<span class="fc bfc" id="L90" title="All 2 branches covered.">        for (Descriptors.FieldDescriptor field : descriptor.getFields()) {</span>
<span class="fc" id="L91">            ObjectPropertyBase objectPropertyBase = buildProperty(field, rawType, isBuilder);</span>
<span class="fc" id="L92">            context.propertyBaseMap().put(objectPropertyBase.name(), objectPropertyBase);</span>
<span class="fc" id="L93">        }</span>
<span class="fc" id="L94">        return false;</span>
    }

    private @Nonnull ObjectPropertyBase buildProperty(
        @Nonnull Descriptors.FieldDescriptor field,
        @Nonnull Class&lt;?&gt; rawClass,
        boolean isBuilder
    ) throws Exception {

<span class="fc" id="L103">        String rawName = field.getName();</span>

        // map
<span class="fc bfc" id="L106" title="All 2 branches covered.">        if (field.isMapField()) {</span>
<span class="fc" id="L107">            String name = rawName + &quot;Map&quot;;</span>
<span class="fc" id="L108">            Method getterMethod = rawClass.getMethod(&quot;get&quot; + StringKit.capitalize(name));</span>
<span class="fc" id="L109">            Invocable getter = Invocable.of(getterMethod);</span>
<span class="fc" id="L110">            Invocable setter = null;</span>
<span class="fc bfc" id="L111" title="All 2 branches covered.">            if (isBuilder) {</span>
<span class="fc" id="L112">                Method clearMethod = rawClass.getMethod(&quot;clear&quot; + StringKit.capitalize(rawName));</span>
<span class="fc" id="L113">                Method putAllMethod = rawClass.getMethod(&quot;putAll&quot; + StringKit.capitalize(rawName), Map.class);</span>
<span class="fc" id="L114">                setter = new MapSetter(clearMethod, putAllMethod);</span>
            }
<span class="fc" id="L116">            return new PropertyBaseImpl(</span>
                rawName,
<span class="fc" id="L118">                getterMethod.getGenericReturnType(),</span>
                getterMethod,
                null,
                getter,
                setter
            );
        }

        // repeated
<span class="fc bfc" id="L127" title="All 2 branches covered.">        if (field.isRepeated()) {</span>
<span class="fc" id="L128">            String name = rawName + &quot;List&quot;;</span>
<span class="fc" id="L129">            Method getterMethod = rawClass.getMethod(&quot;get&quot; + StringKit.capitalize(name));</span>
<span class="fc" id="L130">            Type type = getterMethod.getGenericReturnType();</span>
<span class="fc bfc" id="L131" title="All 2 branches covered.">            if (Objects.equals(type, ProtocolStringList.class)) {</span>
<span class="fc" id="L132">                type = StringListTypeRef.SINGLETON.type();</span>
            }
<span class="fc" id="L134">            Invocable getter = Invocable.of(getterMethod);</span>
<span class="fc" id="L135">            Invocable setter = null;</span>
<span class="fc bfc" id="L136" title="All 2 branches covered.">            if (isBuilder) {</span>
<span class="fc" id="L137">                Method clearMethod = rawClass.getMethod(&quot;clear&quot; + StringKit.capitalize(rawName));</span>
<span class="fc" id="L138">                Method addAllMethod = rawClass.getMethod(&quot;addAll&quot; + StringKit.capitalize(rawName), Iterable.class);</span>
<span class="fc" id="L139">                setter = new ListSetter(clearMethod, addAllMethod);</span>
            }
<span class="fc" id="L141">            return new PropertyBaseImpl(</span>
                rawName,
                type,
                getterMethod,
                null,
                getter,
                setter
            );
        }

        // Simple object
<span class="fc" id="L152">        Method getterMethod = rawClass.getMethod(&quot;get&quot; + StringKit.capitalize(rawName));</span>
<span class="fc" id="L153">        Type type = getterMethod.getGenericReturnType();</span>
<span class="fc" id="L154">        Invocable getter = Invocable.of(getterMethod);</span>
<span class="fc" id="L155">        Method setterMethod = null;</span>
<span class="fc" id="L156">        Invocable setter = null;</span>
<span class="fc bfc" id="L157" title="All 2 branches covered.">        if (isBuilder) {</span>
<span class="fc" id="L158">            setterMethod = rawClass.getMethod(&quot;set&quot; + StringKit.capitalize(rawName), TypeKit.getRawClass(type));</span>
<span class="fc" id="L159">            setter = Invocable.of(setterMethod);</span>
        }
<span class="fc" id="L161">        return new PropertyBaseImpl(</span>
            rawName,
            type,
            getterMethod,
            setterMethod,
            getter,
            setter
        );
    }

    private static final class MapSetter implements Invocable {

        private final @Nonnull MethodHandle clearHandle;
        private final @Nonnull MethodHandle putAllHandle;

<span class="fc" id="L176">        private MapSetter(@Nonnull Method clearMethod, @Nonnull Method putAllMethod) throws Exception {</span>
            // setter = (inst, args) -&gt; {
            //     clearMethod.invoke(inst);
            //     return putAllMethod.invoke(inst, args);
            // };
<span class="fc" id="L181">            this.clearHandle = MethodHandles.lookup().unreflect(clearMethod);</span>
<span class="fc" id="L182">            this.putAllHandle = MethodHandles.lookup().unreflect(putAllMethod);</span>
<span class="fc" id="L183">        }</span>

        @Override
        public @Nullable Object invokeChecked(
            @Nullable Object inst, @Nullable Object @Nonnull ... args
        ) throws Throwable {
<span class="fc" id="L189">            clearHandle.invoke(inst);</span>
<span class="fc" id="L190">            putAllHandle.invoke(inst, args[0]);</span>
<span class="fc" id="L191">            return null;</span>
        }
    }

    private static final class ListSetter implements Invocable {

        private final @Nonnull MethodHandle clearHandle;
        private final @Nonnull MethodHandle addAllMethod;

<span class="fc" id="L200">        private ListSetter(@Nonnull Method clearMethod, @Nonnull Method addAllMethod) throws Exception {</span>
            // setter = (inst, args) -&gt; {
            //     clearMethod.invoke(inst);
            //     return addAllMethod.invoke(inst, args);
            // };
<span class="fc" id="L205">            this.clearHandle = MethodHandles.lookup().unreflect(clearMethod);</span>
<span class="fc" id="L206">            this.addAllMethod = MethodHandles.lookup().unreflect(addAllMethod);</span>
<span class="fc" id="L207">        }</span>

        @Override
        public @Nullable Object invokeChecked(
            @Nullable Object inst, @Nullable Object @Nonnull ... args
        ) throws Throwable {
<span class="fc" id="L213">            clearHandle.invoke(inst);</span>
<span class="fc" id="L214">            addAllMethod.invoke(inst, args[0]);</span>
<span class="fc" id="L215">            return null;</span>
        }
    }

    private static final class PropertyBaseImpl implements ObjectPropertyBase {

        private final @Nonnull String name;
        private final @Nonnull Type type;
        private final @Nullable Method getterMethod;
        private final @Nullable Method setterMethod;
        private final @Nonnull Invocable getter;
        private final @Nullable Invocable setter;

        private PropertyBaseImpl(
            @Nonnull String name,
            @Nonnull Type type,
            @Nullable Method getterMethod,
            @Nullable Method setterMethod,
            @Nonnull Invocable getter,
            @Nullable Invocable setter
<span class="fc" id="L235">        ) {</span>
<span class="fc" id="L236">            this.name = name;</span>
<span class="fc" id="L237">            this.type = type;</span>
<span class="fc" id="L238">            this.getterMethod = getterMethod;</span>
<span class="fc" id="L239">            this.setterMethod = setterMethod;</span>
<span class="fc" id="L240">            this.getter = getter;</span>
<span class="fc" id="L241">            this.setter = setter;</span>
<span class="fc" id="L242">        }</span>

        @Override
        public @Nonnull String name() {
<span class="fc" id="L246">            return name;</span>
        }

        @Override
        public @Nonnull Type type() {
<span class="fc" id="L251">            return type;</span>
        }

        @Override
        public @Nullable Method getterMethod() {
<span class="fc" id="L256">            return getterMethod;</span>
        }

        @Override
        public @Nullable Method setterMethod() {
<span class="fc" id="L261">            return setterMethod;</span>
        }

        @Override
        public @Nullable Field field() {
<span class="fc" id="L266">            return null;</span>
        }

        @Override
        public @Nonnull Invocable getter() {
<span class="fc" id="L271">            return getter;</span>
        }

        @Override
        public @Nullable Invocable setter() {
<span class="fc" id="L276">            return setter;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>